# MazeMaster2D 项目

2D 地下城管理游戏项目，从 Python 版本迁移而来。

---

## 开发规范

### Git Commit 规范

**重要：所有 Git commit 操作必须事先获得用户授权。AI助手不得自行执行 `git commit` 命令。**

本项目采用统一的 Git commit 消息格式：

**格式要求**：
- 使用英文
- 单行，不超过80字符
- 格式：`<type>: <brief description>`

**示例**：
```
Phase 2 Stage 2: Add ASCII visualization and interactive pathfinding
Phase 2 Stage 1: Implement A* and DFS pathfinding algorithms
Phase 1 Stage 4: Poisson disk sampling for cavity generation
Phase 1 Stage 3: Cavity system and simple cavity generation
Phase 1 Stage 1-2: Project initialization and terrain manager
```

**类型说明**：
- `Phase n`: 阶段完成（仅在所有子阶段完成后使用，表示整个阶段完成）
- `Phase n Stage m`: 子阶段完成（阶段被拆分为多个提交时必须使用此格式）
- `Feat`: 新功能（实现新系统、添加新算法、添加新功能）
- `Fix`: 错误修复（修复bug、解决崩溃问题）
- `Refactor`: 代码重构（改进代码结构、优化性能）

---

## 项目技术栈

**项目类型**：2D 地下城管理游戏  
**开发引擎**：Godot Engine  
**Godot 版本**：Godot_v4.3-beta2_win64  
**引擎路径**：D:\develop\Godot\Godot_v4.3-beta2_win64  
**文档格式**：Markdown（纯逻辑描述，无代码示例）

### 文档编写规范

**重要**：所有 `@docs` 和 `@plan` 文档均为逻辑描述文档，不包含代码实现细节。

#### 文档编写原则
1. **描述核心逻辑**：说明系统如何工作，而非如何实现
2. **避免代码示例**：不包含具体代码实现、API调用、配置文件示例等
3. **使用表格和列表**：用结构化的方式展示配置和属性
4. **YAML 配置示例**：工作流配置使用 YAML 格式（逻辑配置，非实际代码）
5. **接口和类名**：仅作为概念引用，标注为"待实现"

#### 文档分类
- **`@docs`**：系统设计文档，描述游戏逻辑、数据结构、配置
- **`@plan`**：项目计划文档，描述开发阶段、任务清单
- 实际代码实现：在项目源码目录中

---

## 核心术语

### 单位相关
- **种族**：单位本身的类型（哥布林/地精/兽人/狼人/巨魔/牛头人/半人马）
- **职业**：统一种族的不同工作（斥候/战士/猎手等）

### 单位获取方式
- **进化**：消耗金币、魔力、时间将一个种族转化为另一个种族
- **训练**：消耗金币、时间将同一种族的单位从一个职业转化为另一个职业
- **召唤**：消耗魔力、时间并进行特殊的操作（例如仪式）凭空产生一个单位

### 资源交互
- **购买**：消耗自身的金币交互各种资源（食物、装备等）

### 战斗系统
- **命令**：以一定的金钱作为悬赏，让各种单位优先执行某个工作，进攻或防御某个目标，参与命令的单位将平分悬赏

### 单位分类
- **功能类（4种）**：哥布林、地精、地精酒保、地精铁匠（遇敌逃跑）
- **战斗类（18种）**：哥布林斥候、哥布林战士、兽人、兽人打手、兽人斥候、兽人猎手、兽人劲弩猎手、兽人战士、兽人重装战士、兽人角斗士、兽人王牌斗士、兽人冠军、兽人驯兽师、兽人萨满、狼人、巨魔、牛头人、半人马（遇敌反击）

---

## 项目结构

### 当前项目结构

```
MazeMaster2D/
├── scripts/                 # 核心模块
│   ├── main.lua            # 模块入口
│   ├── constants/          # 常量定义
│   │   ├── enums.lua       # 枚举（TerrainType, CavityType等）
│   │   └── game_constants.lua  # 游戏常量
│   ├── core/               # 核心基类
│   │   ├── base_manager.lua   # 管理器基类
│   │   └── cavity.lua         # 空洞数据结构
│   ├── managers/           # 管理器实现
│   │   ├── terrain_manager.lua  # 地形管理器
│   │   ├── cavity_manager.lua   # 空洞管理器
│   │   └── pathfinding_manager.lua  # 寻路管理器
│   ├── algorithms/         # 算法库
│   │   ├── poisson_disk_sampling.lua  # 泊松圆盘算法
│   │   ├── bresenham_line.lua         # Bresenham线算法
│   │   ├── astar.lua                 # A*寻路算法
│   │   └── dfs.lua                   # DFS后备算法
│   ├── systems/            # 系统层
│   │   ├── map_generation/    # 地图生成系统
│   │   │   ├── simple_cavity_generator.lua  # 空洞生成器
│   │   │   └── channel_generator.lua        # 通道生成器
│   │   └── pathfinding/        # 寻路系统
│   │       └── grid_pathfinding.lua    # 网格寻路接口
│   └── utils/              # 工具函数
│       └── coordinate_utils.lua   # 坐标转换工具
├── docs/                    # 系统设计文档
│   ├── 单位系统.md
│   ├── 建筑系统.md
│   ├── 工作流配置系统.md
│   ├── 地图生成系统.md
│   └── 单位属性配置表.md
├── plan/                    # 项目计划
│   └── 项目计划.md
└── README.md                # 项目说明

# 规划中的未来结构
├── entities/               # 实体实现层（待实现）
│   ├── buildings/          # 建筑实体
│   ├── units/              # 单位实体
│   └── resource_nodes/     # 资源节点
├── systems/                # 系统层
│   ├── ai/                 # AI系统（待实现）
│   └── building_construction/ # 建造系统（待实现）
├── effects/                # 特效系统
│   ├── particles/          # 粒子特效
│   └── projectiles/        # 投射物特效
└── ui/                     # UI系统
    ├── panels/             # 面板组件
    └── widgets/            # 控件组件
```

### 架构设计

**模块分层**
- **Core**：核心接口和框架定义，无业务依赖
- **Entities**：实体实现层，实现 Core 接口
- **Managers**：管理器层，管理游戏对象
- **Systems**：系统逻辑实现
- **UI**：用户界面系统
- **Tests**：测试用例

#### 核心设计原则

1. **单向依赖**：依赖关系是单向的，避免循环依赖
2. **接口隔离**：跨模块通过 Core 接口通信，不直接依赖具体实现
3. **分层清晰**：Core → Entities/Managers → Systems → Tests 的清晰分层
4. **扩展友好**：各层可以定义扩展接口

---

## 系统文档

详细的系统设计文档已拆分到独立文档中：

- **[单位系统](docs/单位系统.md)**：22种单位类型详细配置（4种功能类+18种战斗类）、进化训练流程和遇敌行为
- **[单位属性配置表](docs/单位属性配置表.md)**：22种单位的完整属性配置（生命值、攻击力、护甲值、体型大小等）和平衡分析
- **[建筑系统](docs/建筑系统.md)**：19种建筑类型详细配置（基础设施+存储+训练+防御+魔法+特殊）、功能说明和特殊效果
- **[工作流配置系统](docs/工作流配置系统.md)**：20种模块化状态机、17种完整工作流配置和匹配度分析
- **[地图生成系统](docs/地图生成系统.md)**：空洞系统、泊松圆盘算法、地形管理和AI集成
- **[空洞可视化说明](docs/cavity-visualization.md)**：红色/蓝色/绿色边框的含义说明

---

## 网格系统

### 核心概念

网格系统是MazeMaster2D的基础架构，将游戏地图划分为规则的离散网格单元。

**关键特性**：

1. **离散网格单元**
   - 地图被划分为规则的网格（200x200）
   - 每个网格位置是一个独立的瓦块（Tile）对象
   - 瓦块不是简单的类型值，而是包含完整数据结构的对象
   - 每个瓦块大小为32x32像素

2. **瓦块数据结构**
   每个瓦块（Tile）包含：
   - `position`: Vector2i（网格坐标位置）
   - `terrain_type`: TerrainType（地形类型）
   - `is_walkable`: bool（是否可通行）
   - `is_buildable`: bool（是否可建造）
   - `is_diggable`: bool（是否可挖掘）
   - `state`: TileState（瓦块状态）
   - 其他扩展属性（资源、建筑引用等）

3. **二维数组存储**
   - TileManager使用二维数组 `tiles[x][y]` 存储所有瓦块
   - 每个网格位置对应一个Tile对象实例
   - 支持高效的坐标查询和批量操作

4. **网格坐标系统**
   - 网格坐标（整数）：Vector2i，表示瓦块在网格中的位置
   - 世界坐标（浮点）：Vector2，表示在游戏世界中的像素位置
   - 提供转换函数：网格坐标 ↔ 世界坐标

### 网格系统的作用

1. **寻路系统基础**
   - A*寻路算法基于网格进行路径计算
   - 每个网格单元作为寻路节点
   - 支持高效的路径查询和缓存

2. **实体放置系统**
   - 所有实体（单位、建筑、资源点）基于网格坐标放置
   - 支持精确的位置对齐和碰撞检测
   - 简化建筑布局和空间管理

3. **地形管理系统**
   - 统一的地形类型管理
   - 支持动态地形修改（挖掘、建造）
   - 地形属性自动更新（通行性、可建造性等）

4. **性能优化**
   - 网格系统提供空间索引，支持快速查询
   - 批量操作优化（如区域挖掘、批量更新）
   - 为视锥剔除和LOD系统提供基础

### 实现细节

- **Tile类**: `scripts/core/tile.gd` - 瓦块数据结构
- **TileManager**: `scripts/managers/tile_manager.gd` - 瓦块管理器
- **TerrainManager**: `scripts/managers/terrain_manager.gd` - 地形数据管理
- **网格坐标转换**: `scripts/utils/grid_coordinate.gd` - 网格坐标系统工具类
- **地图尺寸**: 200x200瓦块，每个瓦块32x32像素
- **空洞形状生成**: `scripts/algorithms/hole_shape_generator.gd` - 基于FastNoiseLite的噪声形状生成器

网格系统与寻路系统、实体系统、建造系统等紧密集成，是游戏的底层基础设施。

---

## 核心游戏功能

### 1. 地图生成系统
程序化地图生成，支持空洞系统、泊松圆盘分布算法和地形管理。已实现基于噪声的空洞形状生成（参考 MazeMaster3D），支持噪声形状和有机形状两种随机形状类型。详见：[docs/地图生成系统.md](docs/地图生成系统.md)

### 2. 寻路系统
- **A* 算法**：高性能网格寻路
- **网格寻路接口**：适配200x200地形网格
- **DFS 后备**：当 A* 失败时自动回退
- **路径缓存**：性能优化
- **ASCII可视化**：控制台输出完整地图、路径、起点终点

### 3. 单位系统
22种单位类型，包含4种功能类单位和18种战斗类单位，支持进化、训练、召唤、购买等获取方式。详见：[docs/单位系统.md](docs/单位系统.md)

### 4. 建筑系统
19种建筑类型，覆盖基础设施、存储、训练、防御、魔法和特殊建筑。详见：[docs/建筑系统.md](docs/建筑系统.md)

### 5. 工作流配置系统
20种模块化状态机，17种完整工作流配置，支持灵活的AI行为组合。详见：[docs/工作流配置系统.md](docs/工作流配置系统.md)

### 6. AI 与资源系统
智能任务分配、资源节点管理和 AI 行为系统。

### 7. 战斗系统
- **战斗接口**：攻击目标与攻击者接口
- **自动战斗**：自动处理攻击、冷却、生命恢复
- **阵营系统**：Player/Enemy/Neutral 阵营支持
- **伤害计算**：实际伤害 = max(1, 攻击力 - 护甲值)

### 8. 状态机系统
- **通用框架**：适用于任意实体类型的状态机框架
- **状态接口**：统一的状态接口定义，包含进入、更新、退出、暂停、恢复生命周期
- **状态栈**：支持状态栈模式，用于临时状态（如眩晕、技能释放）管理
- **优先级系统**：状态和转换条件均支持优先级，确保正确的状态切换顺序
- **中断控制**：可配置状态是否可被中断，保护关键状态（如攻击、施法）
- **转换条件**：灵活转换条件，支持复杂逻辑判断
- **状态上下文**：字符串键数据存储机制，支持状态间数据共享
- **状态历史**：自动记录状态转换历史，包含时间戳和转换原因，便于调试
- **事件系统**：提供状态转换事件回调，支持外部系统响应状态变化
- **可视化调试**：状态历史查询和可视化，支持运行时状态监控

### 9. 技能系统
- **技能框架**：技能接口与基类
- **技能示例**：旋风斩等技能
- **冷却管理**：自动冷却时间管理

### 10. 特效系统
- **对象池**：泛型对象池系统
- **投射物**：支持追踪、穿透、弹跳
- **粒子特效**：粒子特效系统
- **性能优化**：最大活跃数量限制

### 11. 渲染系统 ✅ **已完成**
- **TileMap地形渲染**：使用TileMap节点实现高效地形渲染
- **TileSet配置**：运行时创建TileSet资源，tile_size统一为32x32
- **颜色定义**：未挖掘区域 RGB(30,30,30)，已挖掘区域 RGB(100,100,100)，墙壁 RGB(60,60,60)
- **空洞可视化**：Line2D绘制边界框，颜色区分类型（红=关键，蓝=功能，绿=生态）
- **性能优化**：40,000瓦块流畅渲染，稳定60FPS

### 12. UI系统 📋 **待实现**
- **UI核心组件**：UI面板基类、UI管理器
- **资源显示UI**：实时显示黄金、法力等资源数量
- **建造面板UI**：建筑选择和放置UI
- **建筑信息UI**：显示建筑详细信息、生命值和建造进度
- **角色图鉴UI**：显示所有单位和建筑的图鉴信息，支持筛选
- **状态指示器**：显示单位和建筑的实时状态和生命值，支持世界空间和屏幕空间
- **UI辅助系统**：提供动画功能（淡入淡出、缩放、滑动、弹跳、震动）和输入处理（键盘快捷键、点击外部关闭）
- **事件驱动**：使用事件系统自动更新UI显示

### 13. 调试工具
- **路径可视化**：黄色路径线，绿色起点，红色终点
- **通达性可视化**：绿色半透明方块
- **阻挡可视化**：红色半透明方块
- **热力图**：三种模式（距离基地、寻路成本、瓦片使用）
- **性能统计**：FPS、分辨率、瓦片计数等
- **状态机可视化**：显示实体的当前状态和状态转换历史（规划中）

---

## 项目计划

详细计划请参考：[项目计划.md](项目计划.md)

**重要说明**：
- `项目计划.md` 是逻辑计划文档，描述开发阶段和任务清单
- 每个阶段完成后必须能够运行并查看该阶段实现的内容
- 不包含代码实现细节或特定引擎语法
- 所有接口和类名仅为概念引用，标注为"待实现"
- 实际代码实现将在项目源码中完成
- **进度更新**：README.md 不更新进度信息，进度信息仅在 `项目计划.md` 中更新和维护

### 可运行开发阶段

项目规划为15个阶段，每个阶段都有明确的可运行目标和可视化内容：

| 阶段           | 可运行目标           | 可视化内容                   | 预计时间               |
| -------------- | -------------------- | ---------------------------- | ---------------------- |
| **阶段0**      | 启动项目并基础渲染   | 基础场景                     | 1周                    |
| **第一阶段**   | 地图生成可视化       | 地形、空洞、通道             | 3-4周                  |
| **第二阶段**   | 寻路可视化           | 路径、起点、终点、可达性     | 2-3周                  |
| **第三阶段**   | 基础实体与资源可视化 | 地牢之心、金矿、哥布林       | 3-4周                  |
| **第四阶段**   | 状态机可视化         | 状态转换、工作流             | 4-5周                  |
| **第五阶段**   | 挖矿工作流可视化     | 挖矿循环、金币增加           | 2-3周                  |
| **第六阶段**   | 建造系统可视化       | 建造进度、建筑完成           | 3-4周                  |
| **第七阶段**   | 单位训练可视化       | 训练进度、进化效果           | 3-4周                  |
| **第八阶段**   | 战斗系统可视化       | 战斗过程、伤害、死亡         | 3-4周                  |
| **第九阶段**   | 完整单位工作流可视化 | 各种工作流执行               | 4-5周                  |
| **第十阶段**   | 完整游戏循环         | 资源循环、单位循环、建筑功能 | 3-4周                  |
| **第十一阶段** | UI系统可视化         | UI界面、图鉴                 | 3-4周                  |
| **第十二阶段** | 特效系统可视化       | 攻击特效、粒子效果           | 2-3周                  |
| **第十三阶段** | 英雄AI与挑战         | 英雄入侵、防御战斗           | 2-3周                  |
| **第十四阶段** | 高级功能扩展（可选） | 音效、地图扩展               | 3-4周                  |
| **第十五阶段** | 优化与打磨           | 性能优化、bug修复            | 2-3周                  |
| **总计**       | **完整可玩游戏**     | **渐进式完整功能**           | **41-53周（1-1.3年）** |

### 核心系统优先级

**最高优先级**（前8个阶段）：
- 地图生成 → 寻路 → 基础实体 → 状态机 → 挖矿 → 建造 → 训练 → 战斗

**高优先级**（第9-10阶段）：
- 完整单位实现 → 完整游戏循环

**中优先级**（第11-13阶段）：
- UI系统 → 特效系统 → 英雄AI

**低优先级**（第14阶段，可选）：
- 高级功能扩展

**优化阶段**（第15阶段）：
- 性能优化与打磨

详细开发计划请查看：[项目计划.md](项目计划.md)

---

## 技术细节

### 测试覆盖（规划中）

**单元测试**
- 瓦片管理器测试（初始化、获取、挖掘、保存/加载）
- 寻路系统测试（有效路径、阻挡、同点路径）
- 空洞数据结构测试（构造、Contains、GetBounds、GetArea）
- 空洞管理器测试（注册、注销、查找、按类型查找）
- 地形管理器测试（初始化、设置、获取、批量挖掘）
- 泊松圆盘算法测试（点生成、距离验证、边界检查）
- 资源节点管理器测试（注册、查找、可用性）
- 单位管理器测试（注册、按阵营/类型查找、查找敌人）
- 金矿生成器测试（在空洞中生成金矿）
- 任务分配系统测试（任务查询、取消）

**集成测试**
- 战斗系统测试（范围内攻击、范围外无伤害）
- 建造系统集成测试
- 修复系统集成测试

### 性能优化
- **对象池**：投射物和特效使用对象池减少创建开销
- **路径缓存**：寻路结果缓存减少重复计算
- **通达性更新**：智能更新机制，仅在必要时重新计算
- **性能限制**：最大活跃投射物/粒子数量限制

### 调试功能
调试系统提供完整的可视化功能：
- 切换显示选项（路径、通达性、阻挡、热力图）
- 实时性能统计
- 热力图类型切换
- 状态机可视化（规划中）
- 地图生成可视化：空洞边界、类型颜色区分、通道路径

---

## 许可证

本项目为游戏开发迁移项目。
