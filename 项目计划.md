# MazeMaster2D 项目计划

## 项目概述

MazeMaster2D 是一个2D地下城管理游戏项目。

**核心系统**：
- 22种单位（4种功能类 + 18种战斗类）
- 19种建筑（基础设施 + 存储 + 训练 + 防御 + 魔法 + 特殊）
- 20种基础状态机
- 17种工作流配置
- 程序化地图生成

**重要原则**：每个阶段完成后必须能够运行并查看该阶段实现的内容。

---

## 开发优先级说明

### 优先级分类

| 优先级   | 说明         | 阶段分布     | 核心目标                             |
| -------- | ------------ | ------------ | ------------------------------------ |
| **最高** | 必须首先实现 | 阶段0-2      | 初始化环境并实现可视化Demo和相机系统 |
| **高**   | 核心游戏内容 | 阶段3-11, 16 | 完整的游戏功能和核心玩法             |
| **中**   | 增强体验     | 阶段12-14    | UI、特效、挑战内容                   |
| **低**   | 可选扩展     | 阶段15       | 音效、地图扩展、高级功能             |

### 开发里程碑

- **里程碑1**（阶段0-2）：可运行的可视化Demo与相机系统
- **里程碑2**（阶段3-5）：基础系统框架（地图、寻路、渲染相机、实体、状态机）
- **里程碑3**（阶段6-9）：核心玩法循环（挖矿、建造、训练、战斗）
- **里程碑4**（阶段10-11）：完整单位工作和游戏循环
- **里程碑5**（阶段12-14）：完整的游戏体验和挑战
- **里程碑6**（阶段15-16）：扩展功能和最终优化

---

## 核心系统概览

| 系统类别     | 系统名称     | 完成状态   | 说明                                             |
| ------------ | ------------ | ---------- | ------------------------------------------------ |
| **基础架构** | 状态机系统   | 📋 待实现   | 通用状态机框架，20种基础状态机                   |
| **基础架构** | 工作流系统   | 📋 待实现   | 统一配置API，17种工作流                          |
| **基础架构** | 事件系统     | 📋 待实现   | 中央事件总线                                     |
| **基础架构** | 管理器基类   | ✅ 已完成   | 管理器基类，统一单例实现                         |
| **实体系统** | 单位系统     | 📋 待实现   | 22种单位（4种功能类+18种战斗类）                 |
| **实体系统** | 建筑系统     | 📋 待实现   | 19种建筑（基础设施+存储+训练+防御+魔法）         |
| **实体系统** | 资源系统     | 📋 待实现   | 资源管理、存储、生成、消耗                       |
| **游戏逻辑** | 地图生成系统 | ✅ 部分完成 | 程序化地图生成、空洞系统、泊松圆盘、噪声形状生成 |
| **游戏逻辑** | 寻路系统     | ✅ 已完成   | A*算法、统一接口、DFS后备                        |
| **游戏逻辑** | AI系统       | 📋 待实现   | 任务分配、单位AI                                 |
| **游戏逻辑** | 战斗系统     | 📋 待实现   | 自动战斗、阵营系统、技能系统                     |
| **视觉系统** | UI系统       | 📋 待实现   | 界面组件、资源显示、建造面板、图鉴               |
| **视觉系统** | 世界渲染     | ✅ 已完成   | 游戏世界渲染、地形可视化、网格系统、相机系统     |
| **视觉系统** | 特效系统     | 📋 待实现   | 投射物、粒子、对象池                             |
| **调试工具** | 可视化调试   | 📋 待实现   | 路径可视化、热力图、状态机可视化                 |

---

## 开发阶段规划

---

## 🚀 最高优先级阶段

### 阶段0：初始化环境

**优先级**：最高 ⭐⭐⭐  
**目标**：初始化开发环境，创建项目基础结构  
**预计时间**：1周

**任务清单**：
- [x] **0.1 环境准备**
  - [x] 选择并配置游戏引擎/框架
  - [x] 配置开发工具和版本控制
  - [x] 设置项目目录结构

- [x] **0.2 项目基础**
  - [x] 创建模块结构（Core/Managers/Systems/Utils）
  - [x] 定义枚举和常量（EntityType, ResourceType, Faction等）
  - [x] 实现管理器基类（统一单例模式）

**依赖关系**：无

---

### 第一阶段：可视化Demo

**优先级**：最高 ⭐⭐⭐  
**目标**：实现可运行的可视化Demo，展示网格地图和瓦片渲染  
**预计时间**：3-4周

**可运行目标**：
- 能够运行游戏并显示网格地图
- 能够生成随机地图（地形、空洞、通道）
- 能够在游戏中可视化显示地图：
  - 地形网格（未挖掘/已挖掘瓦片）
  - 空洞颜色标记（红=关键，蓝=功能，绿=生态）
  - 通道路径标记
- 可以进行基础交互（点击、重新生成地图）
- 性能流畅（稳定60FPS或更高）

**任务清单**：
- [x] **1.1 基础网格地图生成器**
  - [x] 理解网格系统核心概念：**离散的网格单元系统**，每个网格位置是一个独立的瓦块对象
  - [x] 实现地形管理器（二维数组存储 `tiles[x][y]`，每个位置存储Tile对象）
  - [x] 实现基础地形类型枚举
  - [x] 实现200x200网格初始化（明确网格坐标系统：网格坐标 vs 世界坐标）
  - [x] 实现随机地图生成算法

- [x] **1.2 瓦块管理系统**
  - [x] 实现瓦块数据结构（Tile类），包含：
    - [x] position: Vector2i（网格坐标位置）
    - [x] terrain_type: TerrainType（地形类型）
    - [x] is_walkable: bool（是否可通行）
    - [x] is_buildable: bool（是否可建造）
    - [x] is_diggable: bool（是否可挖掘）
    - [x] state: TileState（瓦块状态，可选）
  - [x] 实现瓦块管理器（使用**二维数组存储** `tiles[x][y]`，而不是Dictionary）
  - [x] 确保每个网格位置都有对应的Tile对象实例
  - [x] 配置各瓦块是否可通行（根据地形类型自动计算）
  - [x] 支持瓦块动态更新
  - [x] 支持网格坐标查询和世界坐标转换

- [x] **1.2.5 网格坐标系统**
  - [x] 实现网格坐标与世界坐标的转换函数
  - [x] 实现网格对齐功能（snap_to_grid）
  - [x] 实现网格位置验证（边界检查）
  - [x] 为后续寻路系统预留接口（基于网格的路径查询）

- [x] **1.3 空洞系统**
  - [x] 实现空洞数据结构
  - [x] 实现空洞管理器
  - [x] 实现简单空洞生成器
  - [x] 支持三种空洞类型（Critical, Functional, Ecosystem）
  - [x] 实现基于 FastNoiseLite 的噪声形状生成器（HoleShapeGenerator）
  - [x] 支持噪声形状（NOISE）和有机形状（ORGANIC）

- [x] **1.4 泊松圆盘分布算法**
  - [x] 实现泊松圆盘算法
  - [x] 实现网格加速优化
  - [x] 实现距离验证
  - [x] 集成到空洞生成器
  - [x] 实现基于噪声的随机形状生成（参考 MazeMaster3D）

- [x] **1.5 地图生成流程**
  - [x] 生成关键空洞（地牢之心）
  - [x] 生成功能空洞（泊松圆盘 + 噪声形状）
  - [x] 生成生态空洞（泊松圆盘 + 噪声形状）
  - [x] 实现空洞连接通道（Bresenham线算法，已禁用）

- [x] **1.6 基础渲染功能**
  - [x] 实现地形瓦片渲染（32x32像素/瓦块）
  - [x] 实现空洞颜色渲染
  - [x] 实现通道路径渲染（已禁用）
  - [x] 支持重新生成地图功能

- [x] **1.7 测试与调试**
  - [x] 单元测试：地形管理、瓦块系统、空洞
  - [x] 可视化调试：地图生成可视化
  - [x] 性能测试：确保流畅60FPS

**可视化内容**：
- 地形网格可视化（黑=未挖掘，灰=已挖掘/通道）
- 网格线可视化（帮助理解网格系统，可选）
- 空洞颜色标记（红=关键，蓝=功能，绿=生态）
- 通道路径显示
- 网格边界可视化
- 每个瓦块的网格坐标显示（可选调试模式）
- 地图重新生成功能

**依赖关系**：阶段0

---

## 🔷 高优先级阶段

### 第二阶段：寻路系统

**优先级**：高 ⭐⭐  
**目标**：实现完整的寻路系统，支持路径计算和可视化  
**预计时间**：2-3周

**可运行目标**：
- 能够点击地图计算路径
- 能够可视化显示路径、起点、终点
- 支持阻碍和障碍物
- 性能优化，支持大规模地图

**任务清单**：
- [x] **2.1 寻路算法**
  - [x] 实现A*核心算法
  - [x] 实现AStarGrid2D算法
  - [x] 优先使用AStarGrid2D移动到目标瓦块，再使用A*寻路算法进行精确移动
  - [x] 实现Open/Closed列表优化
  - [x] 实现启发式函数

- [x] **2.2 寻路接口与后备**
  - [x] 实现统一寻路接口
  - [x] 实现DFS后备算法
  - [x] 实现路径缓存优化（可选）
  - [x] 集成寻路管理器

- [x] **2.3 路径可视化**
  - [x] 实现路径渲染
  - [x] 实现起点/终点标记
  - [x] 实现阻挡可视化
  - [x] 集成鼠标点击交互

- [x] **2.4 测试与调试**
  - [x] 单元测试：A*算法、DFS后备
  - [x] 性能测试：寻路效率
  - [x] 可视化测试：完整交互流程

**依赖关系**：第一阶段

---

### 第三阶段：地图渲染与相机系统

**优先级**：最高 ⭐⭐⭐  
**目标**：实现现代化地图渲染器和WASD控制相机系统  
**预计时间**：1-2周

**可运行目标**：
- 能够使用WASD键控制相机移动
- 能够使用鼠标滚轮缩放相机
- 地图显示为现代化网格系统（深灰色网格背景）
- 已挖掘区域显示为浅灰色方块
- 未挖掘区域显示为深色背景
- 网格线清晰可见，提供空间定位参考
- 平滑的相机移动和缩放效果

**任务清单**：
- [x] **3.1 相机系统**
  - [x] 实现相机控制器基类
  - [x] 实现WASD键盘输入映射
  - [x] 实现相机移动平滑插值
  - [x] 实现相机边界限制
  - [x] 实现鼠标滚轮缩放功能

- [x] **3.2 地图渲染优化**
  - [x] 重写地形渲染器（现代化视觉风格）
  - [x] 定义精确颜色值：
    - [x] 未挖掘区域：深灰色背景 `RGB(30, 30, 30)` 或 `Color(0.118, 0.118, 0.118)`
    - [x] 已挖掘区域：浅灰色格子 `RGB(100, 100, 100)` 或 `Color(0.392, 0.392, 0.392)`
    - [x] 墙壁区域：中灰色 `RGB(60, 60, 60)` 或 `Color(0.235, 0.235, 0.235)`
  - [x] 实现深灰色网格背景渲染
  - [x] 实现浅灰色已挖掘区域渲染
  - [x] 实现深色未挖掘区域渲染
  - [x] 使用TileMap优化渲染性能（替代ColorRect批量绘制）
  - [x] 性能测试：TileMap渲染200x200=40,000瓦块的高性能

- [x] **3.3 网格可视化**
  - [x] 通过颜色对比自然形成网格感（TileMap特性）
  - [x] 实现网格坐标显示（调试模式）
  - [x] 预留可选网格切换功能接口

- [x] **3.4 集成与测试**
  - [x] 集成相机系统到主场景
  - [x] 集成渲染器到主场景
  - [x] 性能测试：确保流畅60FPS
  - [x] 交互测试：键盘和鼠标操作

- [x] **3.5 相机系统优化（后续改进）**
  - [x] 实现平滑缩放过渡（目标缩放值插值）
  - [x] 扩大缩放范围（min_zoom: 0.05, max_zoom: 3.0）
  - [x] 优化缩放增量（zoom_speed: 0.01，需要更多次滚动）
  - [x] 实现平滑缩放速度控制（zoom_smooth_speed: 8.0）

- [x] **3.6 地图生成优化（后续改进）**
  - [x] 增大空洞生成尺寸（小/中/大：4x4, 8x8, 12x12）
  - [x] 实现空洞重叠检测（防止重复生成）
  - [x] 更新大小分类标准（面积阈值：30, 100）
  - [x] 关键空洞使用大空洞尺寸（12x12）

**可视化效果**：
- 深灰色网格作为地图背景（RGB(30,30,30)）
- 浅灰色方块表示已挖掘/可通行区域（RGB(100,100,100)）
- 深色背景表示未挖掘区域
- 通过颜色对比自然形成网格线效果（可选添加显式网格线）
- 相机流畅移动和缩放

**依赖关系**：第二阶段

---

### 第四阶段：基础实体与资源系统

**优先级**：高 ⭐⭐  
**目标**：实现基础实体系统、资源管理和基础单位  
**预计时间**：3-4周

**可运行目标**：
- 能够在地图上放置地牢之心（主基地）
- 能够在随机位置生成金矿资源点
- 能够生成哥布林单位（初始单位）
- 能够显示建筑、资源点、单位位置

**任务清单**：
- [ ] **4.1 实体基础架构**
  - [ ] 实现实体接口
  - [ ] 实现实体基类
  - [ ] 实现实体类型系统
  - [ ] 实现实体管理器

- [ ] **4.2 资源系统**
  - [ ] 实现资源容器
  - [ ] 实现资源存储接口
  - [ ] 实现资源管理器
  - [ ] 实现整数资源系统（金币、魔力、食物）

- [ ] **4.3 资源节点**
  - [ ] 实现资源节点接口
  - [ ] 实现金矿实体
  - [ ] 实现资源节点管理器
  - [ ] 实现金矿生成器

- [ ] **4.4 基础建筑**
  - [ ] 实现建筑接口
  - [ ] 实现建筑基类
  - [ ] 实现地牢之心建筑
  - [ ] 实现建筑管理器

- [ ] **4.5 基础单位**
  - [ ] 实现单位接口
  - [ ] 实现单位基类
  - [ ] 实现哥布林单位（基础工人）
  - [ ] 实现单位管理器

- [ ] **4.6 实体渲染**
  - [ ] 实现建筑渲染
  - [ ] 实现资源点渲染
  - [ ] 实现单位渲染
  - [ ] 实现UI覆盖层（资源数值显示）

- [ ] **4.7 地图资源生成集成**
  - [ ] 在功能空洞中生成金矿
  - [ ] 验证金矿位置（地形、冲突、距离）
  - [ ] 更新地图生成器集成

- [ ] **4.8 基础UI**
  - [ ] 实现资源显示UI（金币、魔力、食物）
  - [ ] 实现单位信息显示
  - [ ] 实现简单控制面板（用于在调试模式中放置单位）

**依赖关系**：第三阶段

---

### 第五阶段：状态机与工作流系统

**优先级**：高 ⭐⭐  
**目标**：实现完整的状态机框架和工作流系统  
**预计时间**：4-5周

**可运行目标**：
- 能够为哥布林配置工作流
- 能够可视化显示哥布林的状态转换
- 能够看到哥布林的基础AI行为（状态切换）

**任务清单**：
- [ ] **5.1 状态机核心**
  - [ ] 实现状态接口（进入、更新、退出、暂停、恢复）
  - [ ] 实现状态基类
  - [ ] 实现状态上下文
  - [ ] 实现状态机主类

- [ ] **5.2 状态机高级特性**
  - [ ] 实现状态栈模式
  - [ ] 实现优先级系统
  - [ ] 实现中断控制
  - [ ] 实现转换条件
  - [ ] 实现状态历史记录

- [ ] **5.3 基础状态机集合（20种）**
  - [ ] 查找类状态机（3种）：FindTarget, FindStorage, FindNearestEnemy
  - [ ] 移动类状态机（4种）：MoveToTarget, MoveToPosition, PatrolToPoint, MoveAwayFromTarget
  - [ ] 交互类状态机（5种）：Interaction, Attack, TakeResource, StoreResource, TransferResource
  - [ ] 等待检查类（6种）：Wait, CheckCondition, CheckStorageCapacity, CheckTargetStatus, Patrol, Guard
  - [ ] 行为类（2种）：Idle, Flee

- [ ] **5.4 工作流系统核心**
  - [ ] 实现工作流配置类（统一配置结构）
  - [ ] 实现工作流执行器
  - [ ] 实现工作流管理器
  - [ ] 实现统一工作流注册API

- [ ] **5.5 可视化调试**
  - [ ] 实现状态机可视化
  - [ ] 实现工作流可视化
  - [ ] 实现状态转换动画

**依赖关系**：第四阶段

---

### 第六阶段：挖矿工作流与基础AI

**优先级**：高 ⭐⭐  
**目标**：实现哥布林的挖矿工作流，完整的挖矿循环  
**预计时间**：2-3周

**可运行目标**：
- 哥布林能够自动寻找金矿
- 哥布林能够移动到金矿并"挖矿"
- 哥布林能够存储挖到的金币到地牢之心
- 能够可视化显示挖矿流程和金币增加

**任务清单**：
- [ ] **6.1 挖矿工作流实现**
  - [ ] 实现挖矿工作流配置
  - [ ] 实现FindTarget查找金矿
  - [ ] 实现MoveToTarget移动到金矿
  - [ ] 实现Interaction挖矿交互
  - [ ] 实现FindStorage查找存储点
  - [ ] 实现StoreResource存储金币
  - [ ] 注册哥布林工作流

- [ ] **6.2 单位移动系统**
  - [ ] 实现单位移动组件
  - [ ] 集成寻路系统到单位移动
  - [ ] 实现移动动画

- [ ] **6.3 交互系统**
  - [ ] 实现单位与资源点的交互
  - [ ] 实现资源消耗和产出逻辑
  - [ ] 实现交互动画

**依赖关系**：第五阶段

---

### 第七阶段：建筑系统与建造

**优先级**：高 ⭐⭐  
**目标**：实现建筑系统，能够建造基础建筑  
**预计时间**：3-4周

**可运行目标**：
- 能够通过UI选择要建造的建筑
- 能够在地图上放置建筑（预览和验证）
- 地精能够自动建造未完成的建筑
- 能够看到建造进度和完成效果

**任务清单**：
- [ ] **7.1 建筑系统基础**
  - [ ] 实现所有19种建筑实体
  - [ ] 实现建筑资源存储系统
  - [ ] 实现建筑状态系统（建造中、完成、损坏）
  - [ ] 实现建筑管理器

- [ ] **7.2 建造系统**
  - [ ] 实现建筑放置验证（地形、冲突、可达性）
  - [ ] 实现建造流程系统
  - [ ] 实现建造工作流
  - [ ] 实现建造进度跟踪

- [ ] **7.3 建造UI**
  - [ ] 实现建造面板UI
  - [ ] 实现建筑放置预览
  - [ ] 实现建筑信息显示

- [ ] **7.4 基础存储建筑**
  - [ ] 实现金库、肉库、矿坑
  - [ ] 实现资源转移逻辑
  - [ ] 实现存储可视化

**依赖关系**：第六阶段

---

### 第八阶段：单位训练与进化

**优先级**：高 ⭐⭐  
**目标**：实现单位训练和进化系统  
**预计时间**：3-4周

**可运行目标**：
- 能够在地牢之心将哥布林进化为地精
- 能够在各建筑进行单位训练
- 能够看到训练进度和完成效果

**任务清单**：
- [ ] **8.1 进化系统**
  - [ ] 实现哥布林→地精进化
  - [ ] 实现哥布林→兽人进化
  - [ ] 实现进化槽位管理
  - [ ] 实现进化进度显示

- [ ] **8.2 训练系统**
  - [ ] 实现各建筑训练功能
  - [ ] 实现训练槽位管理
  - [ ] 实现训练进度显示

- [ ] **8.3 更多单位实现**
  - [ ] 实现地精单位
  - [ ] 实现兽人单位
  - [ ] 实现各职业单位
  - [ ] 实现基础工作流配置

**依赖关系**：第七阶段

---

### 第九阶段：战斗系统

**优先级**：高 ⭐⭐  
**目标**：实现完整的战斗系统  
**预计时间**：3-4周

**可运行目标**：
- 能够生成敌对单位
- 单位能够自动战斗
- 能够看到战斗过程、伤害数值、单位死亡
- 能够看到生命值变化

**任务清单**：
- [ ] **9.1 战斗核心**
  - [ ] 实现战斗目标接口
  - [ ] 实现战斗攻击者接口
  - [ ] 实现战斗系统
  - [ ] 实现阵营系统

- [ ] **9.2 战斗机制**
  - [ ] 实现自动战斗
  - [ ] 实现攻击范围计算
  - [ ] 实现伤害计算
  - [ ] 实现死亡处理

- [ ] **9.3 遇敌行为**
  - [ ] 实现战斗工作流
  - [ ] 实现逃跑工作流
  - [ ] 注册所有单位的战斗/逃跑工作流

- [ ] **9.4 战斗可视化**
  - [ ] 实现攻击动画
  - [ ] 实现伤害数字显示
  - [ ] 实现生命值条
  - [ ] 实现死亡动画

**依赖关系**：第八阶段

---

### 第十阶段：完整单位与工作流

**优先级**：高 ⭐⭐  
**目标**：实现所有22种单位和17种工作流  
**预计时间**：4-5周

**可运行目标**：
- 能够训练和获取所有22种单位
- 每种单位都有完整的AI行为
- 能够看到各种工作流的执行过程

**任务清单**：
- [ ] **10.1 剩余单位实现**
  - [ ] 实现所有18种战斗类单位
  - [ ] 实现4种野兽人
  - [ ] 配置单位属性

- [ ] **10.2 完整工作流实现**
  - [ ] 实现所有17种工作流
  - [ ] 注册所有单位工作流
  - [ ] 配置工作流优先级和触发条件

- [ ] **10.3 特殊系统**
  - [ ] 实现购买装备系统
  - [ ] 实现竞技场晋级系统
  - [ ] 实现仪式召唤系统

**依赖关系**：第九阶段

---

### 第十一阶段：完整游戏循环

**优先级**：高 ⭐⭐  
**目标**：实现完整的游戏玩法循环  
**预计时间**：3-4周

**可运行目标**：
- 完整的资源循环
- 完整的单位循环
- 完整的建筑功能

**任务清单**：
- [ ] **11.1 资源循环优化**
  - [ ] 优化资源分配逻辑
  - [ ] 实现资源流转可视化
  - [ ] 实现资源短缺提示

- [ ] **11.2 建筑功能完善**
  - [ ] 实现所有建筑的特殊效果
  - [ ] 实现箭塔自动攻击
  - [ ] 实现警戒塔驻守系统
  - [ ] 实现酒馆消费系统

- [ ] **11.3 AI优化**
  - [ ] 优化任务分配算法
  - [ ] 实现智能建筑关联

**依赖关系**：第十阶段

---

### 第十六阶段：优化与打磨

**优先级**：高 ⭐⭐  
**目标**：性能优化、bug修复、用户体验优化  
**预计时间**：2-3周

**任务清单**：
- [ ] **16.1 性能优化**
  - [ ] 渲染优化
  - [ ] 内存管理
  - [ ] 批量操作优化

- [ ] **16.2 Bug修复**
  - [ ] 修复所有已知bug
  - [ ] 修复工作流问题
  - [ ] 修复UI问题

- [ ] **16.3 用户体验**
  - [ ] 优化操作流畅度
  - [ ] 优化提示信息
  - [ ] 优化教程引导

**依赖关系**：第十四或第十五阶段

---

## 🔶 中优先级阶段

### 第十二阶段：UI系统完善

**优先级**：中 ⭐  
**目标**：实现完整的UI系统  
**预计时间**：3-4周

**任务清单**：
- [ ] **12.1 UI核心**
  - [ ] 实现UI面板基类
  - [ ] 实现UI管理器
  - [ ] 实现UI动画系统

- [ ] **12.2 游戏主UI**
  - [ ] 实现资源显示UI
  - [ ] 实现建造面板UI
  - [ ] 实现建筑信息UI
  - [ ] 实现单位信息UI

- [ ] **12.3 图鉴系统**
  - [ ] 实现单位图鉴面板
  - [ ] 实现建筑图鉴面板
  - [ ] 实现筛选和搜索功能

**依赖关系**：第十一阶段

---

### 第十三阶段：特效与美化

**优先级**：中 ⭐  
**目标**：实现特效系统和视觉美化  
**预计时间**：2-3周

**任务清单**：
- [ ] **13.1 特效系统**
  - [ ] 实现对象池系统
  - [ ] 实现投射物系统
  - [ ] 实现粒子特效系统

- [ ] **13.2 特效集成**
  - [ ] 攻击特效
  - [ ] 建造特效
  - [ ] 资源特效
  - [ ] 技能特效

**依赖关系**：第十二阶段

---

### 第十四阶段：英雄AI与挑战

**优先级**：中 ⭐  
**目标**：实现英雄AI系统，增加游戏挑战  
**预计时间**：2-3周

**任务清单**：
- [ ] **14.1 英雄AI**
  - [ ] 实现英雄AI系统
  - [ ] 实现入侵行为
  - [ ] 实现目标优先级

- [ ] **14.2 监狱系统**
  - [ ] 实现监狱建筑
  - [ ] 实现俘虏管理
  - [ ] 实现俘虏送到竞技场

**依赖关系**：第十三阶段

---

## 🔸 低优先级阶段

### 第十五阶段：高级功能与扩展

**优先级**：低 🔸  
**目标**：实现高级功能和内容扩展  
**预计时间**：3-4周

**任务清单**：
- [ ] **15.1 音效系统**
  - [ ] 实现音频管理器
  - [ ] 添加背景音乐
  - [ ] 添加音效（建造、战斗、采集等）

- [ ] **15.2 地图扩展**
  - [ ] 实现房间生成系统
  - [ ] 实现迷宫生成系统
  - [ ] 实现生态系统内容

- [ ] **15.3 保存加载**
  - [ ] 实现地图保存
  - [ ] 实现游戏存档
  - [ ] 实现存档管理

**依赖关系**：第十四阶段

---

## 总体时间估算

| 阶段           | 可运行目标           | 预计时间    | 优先级 | 可视化内容                   |
| -------------- | -------------------- | ----------- | ------ | ---------------------------- |
| **阶段0**      | 初始化环境           | 1周         | ⭐⭐⭐    | 项目基础结构                 |
| **第一阶段**   | 可视化Demo           | 3-4周       | ⭐⭐⭐    | 地形、空洞、通道             |
| **第二阶段**   | 寻路系统             | 2-3周       | ⭐⭐     | 路径可视化                   |
| **第三阶段**   | 地图渲染与相机系统   | 1-2周       | ⭐⭐⭐    | 现代化渲染、WASD相机控制     |
| **第四阶段**   | 基础实体与资源       | 3-4周       | ⭐⭐     | 地牢之心、金矿、哥布林       |
| **第五阶段**   | 状态机系统           | 4-5周       | ⭐⭐     | 状态转换、工作流             |
| **第六阶段**   | 挖矿工作流           | 2-3周       | ⭐⭐     | 挖矿循环、金币增加           |
| **第七阶段**   | 建造系统             | 3-4周       | ⭐⭐     | 建造进度、建筑完成           |
| **第八阶段**   | 单位训练             | 3-4周       | ⭐⭐     | 训练进度、进化效果           |
| **第九阶段**   | 战斗系统             | 3-4周       | ⭐⭐     | 战斗过程、伤害、死亡         |
| **第十阶段**   | 完整单位与工作流     | 4-5周       | ⭐⭐     | 各种工作流执行               |
| **第十一阶段** | 完整游戏循环         | 3-4周       | ⭐⭐     | 资源循环、单位循环、建筑功能 |
| **第十二阶段** | UI系统               | 3-4周       | ⭐      | UI界面、图鉴                 |
| **第十三阶段** | 特效系统             | 2-3周       | ⭐      | 攻击特效、粒子效果           |
| **第十四阶段** | 英雄AI与挑战         | 2-3周       | ⭐      | 英雄入侵、防御战斗           |
| **第十五阶段** | 高级功能扩展（可选） | 3-4周       | 🔸      | 音效、地图扩展               |
| **第十六阶段** | 优化与打磨           | 2-3周       | ⭐⭐     | 性能优化、bug修复            |
| **合计**       | **完整可玩游戏**     | **41-56周** | -      | 渐进式完整功能               |

**保守估计完成时间**：约1-1.3年（全职开发）

---

## 关键依赖关系图

```
阶段0（初始化环境）
  ↓
第一阶段（可视化Demo）
  ↓
第二阶段（寻路系统）
  ↓
第三阶段（地图渲染与相机系统）
  ↓
第四阶段（基础实体） ← 第三阶段
  ↓
第五阶段（状态机） ← 第四阶段
  ↓
第六阶段（挖矿） ← 第五阶段
  ↓
第七阶段（建造） ← 第六阶段
  ↓
第八阶段（训练） ← 第七阶段
  ↓
第九阶段（战斗） ← 第八阶段
  ↓
第十阶段（完整单位） ← 第九阶段
  ↓
第十一阶段（游戏循环） ← 第十阶段
  ↓
第十二阶段（UI） ← 第十一阶段
  ↓
第十三阶段（特效） ← 第十二阶段
  ↓
第十四阶段（英雄AI） ← 第十三阶段
  ↓
第十五阶段（扩展） ← 第十四阶段（可选）
  ↓
第十六阶段（优化） ← 第十四或第十五阶段
```

---

## 配置系统说明

### 统一配置API

项目使用统一的配置API实现两个关键功能：

1. **工作流构建API**：
   - 所有工作流使用统一的配置结构创建
   - 支持参数化配置、转换条件、上下文数据
   - 详见：[工作流配置系统.md](docs/工作流配置系统.md)

2. **单位工作流注册API**：
   - 所有单位使用统一的注册接口关联多个工作流
   - 支持优先级、触发条件、中断规则配置
   - 新增单位只需创建工作流+注册工作流

### 配置优势

- **统一管理**：所有配置使用统一结构
- **易于扩展**：新增单位无需修改系统代码
- **配置驱动**：通过配置文件而非硬编码
- **灵活组合**：状态机可被多个工作流复用

详细配置说明请参见：
- [工作流配置系统.md](docs/工作流配置系统.md) - 工作流配置和API
- [单位属性配置表.md](docs/单位属性配置表.md) - 单位属性配置系统
- [建筑系统.md](docs/建筑系统.md) - 建筑配置
- [单位系统.md](docs/单位系统.md) - 单位配置

---

## 当前进度

### 项目状态：🚧 开发中

**当前阶段**：第四阶段（基础实体与资源系统）进行中 🚧

**已完成内容**：
- ✅ 阶段0：初始化环境
  - ✅ 项目结构创建（Godot项目、目录结构）
  - ✅ 枚举和常量定义（TerrainType、CavityType等）
  - ✅ 管理器基类（单例模式）
  - ✅ 空洞数据结构

- ✅ 第一阶段：可视化Demo
  - ✅ 200x200网格地图系统（瓦块大小32x32像素）
  - ✅ 地形管理器（二维数组存储）
  - ✅ 瓦块管理系统（Tile类、TileManager、属性自动计算）
  - ✅ 网格坐标系统（坐标转换、对齐、验证）
  - ✅ 空洞系统（关键、功能、生态三种类型）
  - ✅ 泊松圆盘分布算法（Bridson算法、网格加速）
  - ✅ 基于噪声的空洞形状生成（HoleShapeGenerator，参考 MazeMaster3D）
    - ✅ 噪声形状（NOISE）：多层噪声扰动
    - ✅ 有机形状（ORGANIC）：5层噪声叠加
  - ✅ 地图生成流程（关键空洞、功能空洞20个、生态空洞15个）
  - ✅ Bresenham线算法（通道生成，已禁用）
  - ✅ 基础渲染功能（地形渲染、空洞可视化）
  - ✅ UI控制（重新生成按钮、地图信息显示）

- ✅ 第二阶段：寻路系统
  - ✅ A*核心算法（AStarPathfinding类）
  - ✅ AStarGrid2D集成（GridPathfinding类）
  - ✅ 混合寻路策略（优先AStarGrid2D，后备A*算法）
  - ✅ DFS后备算法（DFSPathfinding类）
  - ✅ PathfindingManager寻路管理器
  - ✅ 路径缓存系统（可选优化）
  - ✅ 路径可视化（PathVisualizer类）
  - ✅ 起点/终点标记（绿色/红色显示）
  - ✅ 鼠标点击交互（Main.gd集成）
  - ✅ Open/Closed列表优化
  - ✅ 曼哈顿距离启发式函数

- ✅ 第三阶段：地图渲染与相机系统
  - ✅ CameraController相机控制器（Camera2D继承）
  - ✅ WASD键盘输入映射
  - ✅ 相机移动平滑插值（position_smoothing）
  - ✅ 相机边界限制
  - ✅ 鼠标滚轮缩放功能
  - ✅ 平滑缩放过渡（目标缩放值插值系统）
  - ✅ 扩大缩放范围（min_zoom: 0.05, max_zoom: 3.0）
  - ✅ 优化缩放增量（zoom_speed: 0.01）
  - ✅ TileMap地形渲染器（替代ColorRect）
  - ✅ 精确颜色值定义（深灰/浅灰/中灰）
  - ✅ 运行时TileSet资源创建
  - ✅ TileSet tile_size设置（32x32瓦块大小统一配置）
  - ✅ CavityVisualizer坐标计算修复（移除错误的 /2 操作）
  - ✅ 延迟初始化AStarGrid2D优化
  - ✅ 相机世界坐标转换集成
  - ✅ 增大空洞生成尺寸（4x4, 8x8, 12x12）
  - ✅ 空洞重叠检测系统（防止重复生成）
  - ✅ 更新大小分类标准（面积阈值：30, 100）

**技术亮点**：
- 实现了完整的离散网格单元系统，每个位置都是独立的Tile对象
- 采用二维数组存储，支持高效查询和批量操作
- 集成FastNoiseLite实现自然的随机空洞形状
- 参考MazeMaster3D的空洞生成策略，优先使用有机形状
- 实现了混合寻路策略：AStarGrid2D快速寻路 + A*算法精确移动
- DFS算法作为后备，确保在任何情况下都能找到可达路径
- 完整的路径可视化系统，支持实时交互测试
- 使用TileMap替代ColorRect，性能大幅提升（40,000瓦块流畅渲染）
- TileSet tile_size统一配置为32x32，确保瓦块尺寸一致性
- Camera2D平滑移动和缩放，现代化视觉体验
- 平滑缩放过渡系统（目标缩放值插值，zoom_smooth_speed控制）
- 扩大缩放范围支持查看完整地图（min_zoom: 0.05, max_zoom: 3.0）
- 空洞重叠检测系统，确保地图生成质量

**下一步行动**：
- 继续第四阶段：基础实体与资源系统的开发和测试

---

*最后更新：2025-01-22（第三阶段完成：相机平滑缩放优化、空洞重叠检测、空洞尺寸优化）*