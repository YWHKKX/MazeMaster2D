# MazeMaster2D 项目计划

## 项目概述

MazeMaster2D 是一个2D地下城管理游戏项目。

**核心系统**：
- 22种单位（4种功能类 + 18种战斗类）
- 19种建筑（基础设施 + 存储 + 训练 + 防御 + 魔法 + 特殊）
- 5种资源类型（3种基础资源：金币、魔力、食物 + 消耗品：铁矿 + 装备）
- 20种基础状态机
- 17种工作流配置
- 程序化地图生成

**重要原则**：每个阶段完成后必须能够运行并查看该阶段实现的内容。

---

## 开发优先级说明

### 优先级分类

| 优先级   | 说明         | 阶段分布     | 核心目标                             |
| -------- | ------------ | ------------ | ------------------------------------ |
| **最高** | 必须首先实现 | 阶段0-2      | 初始化环境并实现可视化Demo和相机系统 |
| **高**   | 核心游戏内容 | 阶段3-11, 16 | 完整的游戏功能和核心玩法             |
| **中**   | 增强体验     | 阶段12-14    | UI、特效、挑战内容                   |
| **低**   | 可选扩展     | 阶段15       | 音效、地图扩展、高级功能             |

### 开发里程碑

- **里程碑1**（阶段0-2）：可运行的可视化Demo与相机系统
- **里程碑2**（阶段3-5）：基础系统框架（地图、寻路、渲染相机、实体、状态机）
- **里程碑3**（阶段6-9）：核心玩法循环（挖矿、建造、训练、战斗）
- **里程碑4**（阶段10-11）：完整单位工作和游戏循环
- **里程碑5**（阶段12-14）：完整的游戏体验和挑战
- **里程碑6**（阶段15-16）：扩展功能和最终优化

---

## 核心系统概览

| 系统类别     | 系统名称     | 完成状态   | 说明                                                                                                                                              |
| ------------ | ------------ | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| **基础架构** | 状态机系统   | 📋 待实现   | 通用状态机框架，20种基础状态机                                                                                                                    |
| **基础架构** | 工作流系统   | 📋 待实现   | 统一配置API，17种工作流                                                                                                                           |
| **基础架构** | 事件系统     | 📋 待实现   | 中央事件总线                                                                                                                                      |
| **基础架构** | 管理器基类   | ✅ 已完成   | 管理器基类，统一单例实现                                                                                                                          |
| **实体系统** | 单位系统     | 📋 待实现   | 22种单位（4种功能类+18种战斗类）                                                                                                                  |
| **实体系统** | 建筑系统     | 📋 待实现   | 19种建筑（基础设施+存储+训练+防御+魔法）                                                                                                          |
| **实体系统** | 资源系统     | ✅ 部分完成 | 资源管理、存储、生成、消耗。资源作为资源瓦块类型存储在网格中。包含5种资源类型：金币、魔力、食物（基础资源，第四阶段已完成）、铁矿（消耗品）、装备 |
| **游戏逻辑** | 地图生成系统 | ✅ 部分完成 | 程序化地图生成、空洞系统、泊松圆盘、噪声形状生成                                                                                                  |
| **游戏逻辑** | 寻路系统     | ✅ 已完成   | A*算法、统一接口、DFS后备                                                                                                                         |
| **游戏逻辑** | AI系统       | 📋 待实现   | 任务分配、单位AI                                                                                                                                  |
| **游戏逻辑** | 战斗系统     | 📋 待实现   | 自动战斗、阵营系统、技能系统                                                                                                                      |
| **视觉系统** | UI系统       | 📋 待实现   | 界面组件、资源显示、建造面板、图鉴                                                                                                                |
| **视觉系统** | 世界渲染     | ✅ 已完成   | 游戏世界渲染、地形可视化、网格系统、相机系统                                                                                                      |
| **视觉系统** | 特效系统     | 📋 待实现   | 投射物、粒子、对象池                                                                                                                              |
| **调试工具** | 可视化调试   | 📋 待实现   | 路径可视化、热力图、状态机可视化                                                                                                                  |

---

## 开发阶段规划

---

## 🚀 最高优先级阶段

### 阶段0：初始化环境

**优先级**：最高 ⭐⭐⭐  
**目标**：初始化开发环境，创建项目基础结构  
**预计时间**：1周

**任务清单**：
- [x] **0.1 环境准备**
  - [x] 选择并配置游戏引擎/框架
  - [x] 配置开发工具和版本控制
  - [x] 设置项目目录结构

- [x] **0.2 项目基础**
  - [x] 创建模块结构（Core/Managers/Systems/Utils）
  - [x] 定义枚举和常量（EntityType, ResourceType, Faction等）
  - [x] 实现管理器基类（统一单例模式）

**依赖关系**：无

---

### 第一阶段：可视化Demo

**优先级**：最高 ⭐⭐⭐  
**目标**：实现可运行的可视化Demo，展示网格地图和瓦片渲染  
**预计时间**：3-4周

**可运行目标**：
- 能够运行游戏并显示网格地图
- 能够生成随机地图（地形、空洞、通道）
- 能够在游戏中可视化显示地图：
  - 地形网格（未挖掘/已挖掘瓦片）
  - 空洞颜色标记（红=关键，蓝=功能，绿=生态）
  - 通道路径标记
- 可以进行基础交互（点击、重新生成地图）
- 性能流畅（稳定60FPS或更高）

**任务清单**：
- [x] **1.1 基础网格地图生成器**
  - [x] 理解网格系统核心概念：**离散的网格单元系统**，每个网格位置是一个独立的瓦块对象
  - [x] 实现地形管理器（二维数组存储 `tiles[x][y]`，每个位置存储Tile对象）
  - [x] 实现基础地形类型枚举
  - [x] 实现200x200网格初始化（明确网格坐标系统：网格坐标 vs 世界坐标）
  - [x] 实现随机地图生成算法

- [x] **1.2 瓦块管理系统**
  - [x] 实现瓦块数据结构（Tile类），包含：
    - [x] position: Vector2i（网格坐标位置）
    - [x] terrain_type: TerrainType（地形类型）
    - [x] is_walkable: bool（是否可通行）
    - [x] is_buildable: bool（是否可建造）
    - [x] is_diggable: bool（是否可挖掘）
    - [x] state: TileState（瓦块状态，可选）
  - [x] 实现瓦块管理器（使用**二维数组存储** `tiles[x][y]`，而不是Dictionary）
  - [x] 确保每个网格位置都有对应的Tile对象实例
  - [x] 配置各瓦块是否可通行（根据地形类型自动计算）
  - [x] 支持瓦块动态更新
  - [x] 支持网格坐标查询和世界坐标转换

- [x] **1.2.5 网格坐标系统**
  - [x] 实现网格坐标与世界坐标的转换函数
  - [x] 实现网格对齐功能（snap_to_grid）
  - [x] 实现网格位置验证（边界检查）
  - [x] 为后续寻路系统预留接口（基于网格的路径查询）

- [x] **1.3 空洞系统**
  - [x] 实现空洞数据结构
  - [x] 实现空洞管理器
  - [x] 实现简单空洞生成器
  - [x] 支持三种空洞类型（Critical, Functional, Ecosystem）
  - [x] 实现基于 FastNoiseLite 的噪声形状生成器（HoleShapeGenerator）
  - [x] 支持噪声形状（NOISE）和有机形状（ORGANIC）

- [x] **1.4 泊松圆盘分布算法**
  - [x] 实现泊松圆盘算法
  - [x] 实现网格加速优化
  - [x] 实现距离验证
  - [x] 集成到空洞生成器
  - [x] 实现基于噪声的随机形状生成（参考 MazeMaster3D）

- [x] **1.5 地图生成流程**
  - [x] 生成关键空洞（地牢之心）
  - [x] 生成功能空洞（泊松圆盘 + 噪声形状）
  - [x] 生成生态空洞（泊松圆盘 + 噪声形状）
  - [x] 实现空洞连接通道（Bresenham线算法，已禁用）

- [x] **1.6 基础渲染功能**
  - [x] 实现地形瓦片渲染（32x32像素/瓦块）
  - [x] 实现空洞颜色渲染
  - [x] 实现通道路径渲染（已禁用）
  - [x] 支持重新生成地图功能

- [x] **1.7 测试与调试**
  - [x] 单元测试：地形管理、瓦块系统、空洞
  - [x] 可视化调试：地图生成可视化
  - [x] 性能测试：确保流畅60FPS

**可视化内容**：
- 地形网格可视化（黑=未挖掘，灰=已挖掘/通道）
- 网格线可视化（帮助理解网格系统，可选）
- 空洞颜色标记（红=关键，蓝=功能，绿=生态）
- 通道路径显示
- 网格边界可视化
- 每个瓦块的网格坐标显示（可选调试模式）
- 地图重新生成功能

**依赖关系**：阶段0

---

## 🔷 高优先级阶段

### 第二阶段：寻路系统

**优先级**：高 ⭐⭐  
**目标**：实现完整的寻路系统，支持路径计算和可视化  
**预计时间**：2-3周

**可运行目标**：
- 能够点击地图计算路径
- 能够可视化显示路径、起点、终点
- 支持阻碍和障碍物
- 性能优化，支持大规模地图

**任务清单**：
- [x] **2.1 寻路算法**
  - [x] 实现A*核心算法
  - [x] 实现AStarGrid2D算法
  - [x] 优先使用AStarGrid2D移动到目标瓦块，再使用A*寻路算法进行精确移动
  - [x] 实现Open/Closed列表优化
  - [x] 实现启发式函数

- [x] **2.2 寻路接口与后备**
  - [x] 实现统一寻路接口
  - [x] 实现DFS后备算法
  - [x] 实现路径缓存优化（可选）
  - [x] 集成寻路管理器

- [x] **2.3 路径可视化**
  - [x] 实现路径渲染
  - [x] 实现起点/终点标记
  - [x] 实现阻挡可视化
  - [x] 集成鼠标点击交互

- [x] **2.4 测试与调试**
  - [x] 单元测试：A*算法、DFS后备
  - [x] 性能测试：寻路效率
  - [x] 可视化测试：完整交互流程

**依赖关系**：第一阶段

---

### 第三阶段：地图渲染与相机系统

**优先级**：最高 ⭐⭐⭐  
**目标**：实现现代化地图渲染器和WASD控制相机系统  
**预计时间**：1-2周

**可运行目标**：
- 能够使用WASD键控制相机移动
- 能够使用鼠标滚轮缩放相机
- 地图显示为现代化网格系统（深灰色网格背景）
- 已挖掘区域显示为浅灰色方块
- 未挖掘区域显示为深色背景
- 网格线清晰可见，提供空间定位参考
- 平滑的相机移动和缩放效果

**任务清单**：
- [x] **3.1 相机系统**
  - [x] 实现相机控制器基类
  - [x] 实现WASD键盘输入映射
  - [x] 实现相机移动平滑插值
  - [x] 实现相机边界限制
  - [x] 实现鼠标滚轮缩放功能

- [x] **3.2 地图渲染优化**
  - [x] 重写地形渲染器（现代化视觉风格）
  - [x] 定义精确颜色值：
    - [x] 未挖掘区域：深灰色背景 `RGB(30, 30, 30)` 或 `Color(0.118, 0.118, 0.118)`
    - [x] 已挖掘区域：浅灰色格子 `RGB(100, 100, 100)` 或 `Color(0.392, 0.392, 0.392)`
    - [x] 墙壁区域：中灰色 `RGB(60, 60, 60)` 或 `Color(0.235, 0.235, 0.235)`
  - [x] 实现深灰色网格背景渲染
  - [x] 实现浅灰色已挖掘区域渲染
  - [x] 实现深色未挖掘区域渲染
  - [x] 使用TileMap优化渲染性能（替代ColorRect批量绘制）
  - [x] 性能测试：TileMap渲染200x200=40,000瓦块的高性能

- [x] **3.3 网格可视化**
  - [x] 通过颜色对比自然形成网格感（TileMap特性）
  - [x] 实现网格坐标显示（调试模式）
  - [x] 预留可选网格切换功能接口

- [x] **3.4 集成与测试**
  - [x] 集成相机系统到主场景
  - [x] 集成渲染器到主场景
  - [x] 性能测试：确保流畅60FPS
  - [x] 交互测试：键盘和鼠标操作

- [x] **3.5 相机系统优化（后续改进）**
  - [x] 实现平滑缩放过渡（目标缩放值插值）
  - [x] 扩大缩放范围（min_zoom: 0.05, max_zoom: 3.0）
  - [x] 优化缩放增量（zoom_speed: 0.01，需要更多次滚动）
  - [x] 实现平滑缩放速度控制（zoom_smooth_speed: 8.0）

- [x] **3.6 地图生成优化（后续改进）**
  - [x] 增大空洞生成尺寸（小/中/大：4x4, 8x8, 12x12）
  - [x] 实现空洞重叠检测（防止重复生成）
  - [x] 更新大小分类标准（面积阈值：30, 100）
  - [x] 关键空洞使用大空洞尺寸（12x12）

**可视化效果**：
- 深灰色网格作为地图背景（RGB(30,30,30)）
- 浅灰色方块表示已挖掘/可通行区域（RGB(100,100,100)）
- 深色背景表示未挖掘区域
- 通过颜色对比自然形成网格线效果（可选添加显式网格线）
- 相机流畅移动和缩放

**依赖关系**：第二阶段

---

### 第四阶段：基础实体与资源系统

**优先级**：高 ⭐⭐  
**目标**：实现基础实体系统、资源管理和基础单位  
**预计时间**：3-4周

**可运行目标**：
- 能够在地图上放置地牢之心（主基地，作为建筑瓦块）
- 能够在地图任意可建造位置生成金矿资源点（作为资源瓦块）
- 能够生成哥布林单位（初始单位，独立可移动实体）
- 能够显示建筑瓦块、资源瓦块、单位位置

**任务清单**：
- [x] **4.1 实体基础架构**
  - [x] 实现实体接口
  - [x] 实现实体基类
  - [x] 实现实体类型系统
  - [x] 实现实体管理器

- [x] **4.2 资源系统（基础资源）**
  - [x] 实现资源容器
  - [x] 实现资源存储接口
  - [x] 实现资源管理器
  - [x] 实现整数资源系统（金币、魔力、食物）

- [x] **4.3 资源瓦块系统（基础资源）**
  - [x] 实现资源瓦块基类（ResourceTile，继承自Tile）
  - [x] 实现金矿瓦块（GoldMineTile）
  - [x] 实现资源瓦块管理器（资源瓦块存储在Tile中，而非独立实体）
  - [x] 实现金矿生成器（在地图任意可建造位置生成金矿瓦块）
  - [ ] 扩展资源瓦块类型（铁矿、食物资源瓦块）- 在第六阶段实现

- [x] **4.4 建筑瓦块系统**
  - [x] 实现建筑瓦块基类（BuildingTile，继承自Tile）
  - [x] 实现地牢之心瓦块（DungeonHeartTile）
  - [x] 实现建筑瓦块管理器（建筑瓦块存储在Tile中，而非独立实体）
  - [x] 实现建筑放置验证系统

- [x] **4.5 基础单位系统**
  - [x] 实现单位基类（Unit，独立于瓦块，可移动）
  - [x] 实现单位类继承体系：
    - [x] 怪物基类（Monster）
    - [x] 英雄基类（Hero）
    - [x] 野兽基类（Beast）
  - [x] 实现哥布林单位（Goblin，继承自Hero）
  - [x] 实现单位管理器（管理可移动的单位实体）

- [x] **4.6 实体渲染**
  - [x] 实现建筑瓦块渲染（从Tile读取BuildingTile数据）
  - [x] 实现资源瓦块渲染（从Tile读取ResourceTile数据）
  - [x] 实现单位渲染（独立的单位实体渲染，不依赖瓦块）
  - [x] 实现UI覆盖层（资源数值显示）

- [x] **4.7 地图资源生成集成**
  - [x] 在地图任意可建造位置生成金矿瓦块
  - [x] 验证金矿瓦块位置（地形、冲突、距离）
  - [x] 更新地图生成器集成（资源作为瓦块类型生成）

- [x] **4.8 基础UI**
  - [x] 实现资源显示UI（金币、魔力、食物）
  - [x] 实现单位信息显示
  - [x] 实现简单控制面板（用于在调试模式中放置单位）

**依赖关系**：第三阶段

---

### 第五阶段：状态机与工作流系统

**优先级**：高 ⭐⭐  
**目标**：实现完整的状态机框架和工作流系统  
**预计时间**：4-5周  
**当前进度**：✅ 已完成（100%完成）

**可运行目标**：
- ✅ 能够为哥布林配置工作流（MiningWorkflow, FleeWorkflow）
- ✅ 能够看到哥布林的基础AI行为（状态切换、工作流执行）
- ✅ 工作流驱动状态转换架构已实现
- ✅ 可视化显示哥布林的状态转换（状态指示器：右上角空心矩形，颜色表示状态）
- ✅ 工作流可视化显示（工作流名称和进度显示在状态指示器下方）
- ✅ 状态转换动画效果（缓动、闪烁、缩放、边框加粗）
- ✅ 基于速度的平滑移动系统（单位使用1瓦块/秒基准速度进行平滑移动）
- ✅ 单位图鉴系统完整实现（所有22种单位数据、详细信息展示、头像显示、性能优化）

**任务清单**：
- [x] **5.1 状态机核心**
  - [x] 实现状态接口（IState：进入、更新、退出、暂停、恢复）
  - [x] 实现状态基类（BaseState）
  - [x] 实现状态上下文（StateContext）
  - [x] 实现状态机主类（StateMachine）
  - [x] 实现状态结果枚举（StateResult：RUNNING, SUCCESS, FAILURE）

- [x] **5.2 状态机高级特性**
  - [x] 实现状态栈模式（_state_stack，支持临时状态）
  - [x] 实现状态历史记录（_history，最多100条记录）
  - [x] 实现共享上下文（_shared_context，所有状态共享数据）
  - [x] 实现优先级系统（通过工作流优先级实现）
  - [x] 实现中断控制（通过工作流interruptible标志实现）
  - [x] 实现转换条件（工作流transitions配置）

- [x] **5.3 基础状态机集合（20种）**
  - [x] 查找类状态机（3种）：FindTargetState, FindStorageState, FindNearestEnemyState
  - [x] 移动类状态机（4种）：MoveToTargetState, MoveToPositionState, PatrolToPointState, MoveAwayFromTargetState
  - [x] 交互类状态机（5种）：InteractionState, AttackState, TakeResourceState, StoreResourceState, TransferResourceState
  - [x] 等待检查类（6种）：WaitState, CheckConditionState, CheckStorageCapacityState, CheckTargetStatusState, PatrolState, GuardState
  - [x] 行为类（2种）：IdleState, FleeState
  - [x] 所有状态已迁移到工作流驱动架构（返回StateResult而非状态名称）

- [x] **5.4 工作流系统核心**
  - [x] 实现工作流配置类（WorkflowConfig，统一配置结构）
  - [x] 实现工作流执行器（WorkflowExecutor，工作流驱动状态转换）
  - [x] 实现工作流管理器（WorkflowManager，管理所有工作流实例）
  - [x] 实现统一工作流注册API（WorkflowRegistry）
  - [x] 实现工作流驱动状态转换架构（WorkflowExecutor主动控制状态转换）
  - [x] 实现状态共享上下文传递（确保数据在工作流状态间传递）
  - [x] 实现哥布林工作流配置（MiningWorkflow, FleeWorkflow）

- [x] **5.5 可视化调试**
  - [x] 实现状态可视化器（StateVisualizer类）
  - [x] 集成状态可视化到主场景（已在EntityRenderer.update_state_visualizations中集成）
  - [x] 实现状态指示器显示（单位右上角空心矩形，颜色表示当前状态）
  - [x] 实现状态颜色配置（所有20种基础状态和6种扩展状态的颜色映射）
  - [x] 实现工作流可视化（显示当前工作流名称和进度，在状态指示器下方）
  - [x] 实现状态转换动画效果（ease-in-out缓动、闪烁效果、缩放动画、边框加粗动画）

- [x] **5.6 单位图鉴系统（完整实现）**
  - [x] 实现单位数据管理（UnitDatabase，存储所有单位的基础信息）
  - [x] 补充所有22种单位数据（扩展UnitData类，添加9项属性字段，初始化完整数据）
  - [x] 实现单位图鉴UI面板框架（UnitBestiary类已实现）
  - [x] 实现单位列表显示（动态创建列表项，支持点击选择）
  - [x] 实现单位搜索功能（按名称搜索已实现）
  - [x] 实现单位筛选功能（按类型、种族筛选已实现）
  - [x] 实现图鉴快捷键（B键打开/关闭图鉴，已在Main.gd中集成）
  - [x] 完成基础UI集成（UnitBestiary已在Main.tscn的UILayer中）
  - [x] 完善单位详细信息展示（显示所有9项属性、工作流列表、描述，包括移动速度等完整属性）
  - [x] 实现单位头像显示（使用img文件夹中的单位图片，支持占位符）
  - [x] 实现性能优化（头像缓存、列表缓存，筛选条件变化检测）

- [x] **5.7 单位移动系统**
  - [x] 实现基于速度的平滑移动系统（双坐标系统：网格坐标+世界坐标）
  - [x] 实现move_towards方法（基于speed * delta的平滑移动）
  - [x] 实现坐标自动同步机制（世界坐标和网格坐标自动同步）
  - [x] 更新MoveToTargetState使用平滑移动（替代网格瞬移）
  - [x] 配置单位速度系统（以瓦块/秒为单位，基准1瓦块/秒）
  - [x] 更新所有22种单位的移动速度配置（在配置表中）
  - [x] 更新代码中的硬编码速度值（基准32像素/秒）

**已完成的核心功能**：
- ✅ 完整的状态机框架（状态接口、基类、上下文、状态机主类）
- ✅ 状态机高级特性（状态栈、历史记录、共享上下文）
- ✅ 20种基础状态机全部实现并迁移到新架构
- ✅ 工作流系统核心（配置、执行器、管理器、注册API）
- ✅ 工作流驱动状态转换架构（WorkflowExecutor主动控制）
- ✅ 哥布林工作流配置（挖矿工作流已实现并测试）
- ✅ 状态可视化系统（状态指示器：单位右上角空心矩形，动态颜色显示）
- ✅ **工作流可视化系统**（在状态指示器下方显示工作流名称和进度）
- ✅ **状态转换动画增强**（ease-in-out缓动、闪烁、缩放、边框加粗效果）
- ✅ **单位图鉴系统完整实现**：
  - 所有22种单位完整数据（9项属性配置）
  - 详细信息展示（属性网格、工作流列表）
  - 单位头像显示（支持图片加载和占位符）
  - 性能优化（头像缓存、列表缓存）
- ✅ 单位图鉴快捷键集成（B键打开/关闭，ESC关闭，已在Main.gd集成）
- ✅ **基于速度的平滑移动系统**（双坐标系统：网格坐标+世界坐标，基于速度平滑移动）
- ✅ **单位速度配置系统**（瓦块/秒格式，基准1瓦块/秒 = 32像素/秒）

**待完成的工作**：
- ✅ 所有核心功能已完成

**技术亮点**：
- ✅ 实现了工作流驱动状态转换架构，状态类返回StateResult而非直接返回下一状态
- ✅ 通过共享上下文（shared_context）实现状态间数据传递，解决了状态转换数据丢失问题
- ✅ 所有20种状态机已完成迁移，统一使用StateResult接口
- ✅ 工作流配置系统支持灵活的状态序列配置和转换条件设置
- ✅ **实现了基于速度的平滑移动系统**：
  - 双坐标系统：网格坐标（逻辑判断）+ 世界坐标（平滑移动）
  - 每帧移动：`speed * delta` 像素，而非网格瞬移
  - 自动同步：世界坐标和网格坐标自动同步
- ✅ **单位速度配置系统**：
  - 以瓦块/秒为单位（便于后续调整瓦块大小）
  - 基准速度：1瓦块/秒 = 1秒/瓦块 = 32像素/秒
  - 所有22种单位速度已配置在配置表中
- ✅ **工作流可视化系统**：
  - 在状态指示器下方实时显示工作流名称和进度（如"MiningWorkflow 2/4"）
  - 通过WorkflowExecutor的get_workflow_name()和get_progress()方法获取信息
- ✅ **状态转换动画增强**：
  - Ease-in-out缓动函数优化颜色插值曲线，提供平滑过渡
  - 闪烁效果：转换期间周期性改变亮度（8Hz频率）
  - 缩放动画：状态指示器从1.0增长到1.3再回到1.0
  - 边框加粗：转换时边框从2.0增加到3.5再回到2.0
- ✅ **单位图鉴系统完整实现**：
  - 所有22种单位完整数据配置（UnitData类扩展9项属性）
  - 动态UI生成：单位列表、详细信息面板（属性网格、工作流列表）
  - 头像系统：图片加载、占位符、缓存机制
  - 性能优化：头像缓存（Dictionary）、列表缓存（条件变化检测）

**依赖关系**：第四阶段

---

### 第六阶段：挖矿工作流与基础AI

**优先级**：高 ⭐⭐  
**目标**：实现哥布林的挖矿工作流，完整的挖矿循环，重构项目结构并使用Godot内置交互系统  
**预计时间**：3-4周

**可运行目标**：
- 哥布林能够自动寻找资源点（金矿、铁矿、食物资源瓦块）
- 哥布林能够移动到资源点并"挖矿"
- 哥布林能够存储挖到的资源到对应存储建筑（金币→地牢之心/金库，铁矿→矿坑，食物→肉库/地牢之心）
- 能够可视化显示挖矿流程和资源增加
- 瓦块和单位渲染效果清晰（瓦块=矩形，单位=图片）
- 项目结构清晰，文件组织规范
- 支持多种资源类型的挖矿工作流（金矿、铁矿、食物资源瓦块）

**任务清单**：
- [x] **6.0 项目结构重构**
  - [x] 重构瓦块文件结构
    - [x] 将所有建筑瓦块类移动到 `scripts/core/buildings/` 文件夹
    - [x] 将所有资源瓦块类移动到 `scripts/core/resources/` 文件夹
    - [x] 确保建筑瓦块基类（BuildingTile）和资源瓦块基类（ResourceTile）在 `scripts/core/` 根目录
  - [x] 重构单位文件结构
    - [x] 创建 `scripts/core/units/monsters/` 文件夹，存放所有怪物类单位
    - [x] 创建 `scripts/core/units/heroes/` 文件夹，存放所有英雄类单位（功能类+战斗类）
    - [x] 创建 `scripts/core/units/beasts/` 文件夹，存放所有野兽类单位
    - [x] 确保怪物基类（Monster）、英雄基类（Hero）、野兽基类（Beast）在 `scripts/core/units/` 根目录
  - [x] 更新所有引用路径（import语句、类引用等）
  - [x] 验证重构后项目可以正常编译和运行

- [x] **6.1 渲染系统规范化**
  - [x] 规范化瓦块渲染
    - [x] 确保所有建筑瓦块渲染为一个瓦块大小的矩形（ColorRect节点）
    - [x] 确保所有资源瓦块渲染为一个瓦块大小的矩形（使用Sprite2D + PixelArtGenerator，32x32像素）
      - [x] **重构金矿渲染**：使用PixelArtGenerator + Sprite2D（32x32像素矩形）
        - [x] 修改 `_create_resource_tile_visual()` 方法
          - [x] 使用PixelArtGenerator创建32x32像素图像
          - [x] 使用Sprite2D节点渲染（完整瓦块大小32x32像素）
          - [x] 保持金色填充颜色（通过像素艺术图案实现）
          - [x] 修改边框（Line2D）：矩形四个角点
          - [x] 保持黑色边框颜色和宽度（2.0）
        - [x] 更新 `_get_resource_node_color()` 确保颜色映射正确
      - [x] 更新其他资源类型渲染为矩形
        - [x] 魔力资源瓦块：使用紫色像素艺术图案
        - [x] 食物资源瓦块：使用棕色像素艺术图案
        - [x] 铁矿资源瓦块：使用灰色像素艺术图案
      - [x] 统一资源瓦块渲染规范：所有资源瓦块使用Sprite2D + 像素艺术纹理（32x32像素矩形）
    - [x] **瓦块内部像素渲染设计**（已实现方案2：动态生成的像素纹理）
      - [x] 研究 Godot 瓦块像素渲染方案
        - [x] **方案2：Sprite2D + 动态生成的像素纹理**（已选择并实现）
          - [x] 使用 `Image.create()` 创建 32x32 像素图像
          - [x] 使用 `Image.fill_rect()` 填充像素区域
          - [x] 使用 `Image.set_pixel()` 绘制像素细节
          - [x] 转换为 `ImageTexture` 应用到 Sprite2D
          - [x] 已创建 `PixelArtGenerator` 工具类
          - [x] 实现常见图案绘制（金矿、魔力、食物、铁矿图标）
      - [x] 实现像素渲染优化
        - [x] 纹理过滤模式：项目设置 → 渲染 → 纹理 → 默认纹理过滤 → "Nearest"（已通过注释说明）
        - [x] 确保像素清晰度：Sprite2D渲染，使用ImageTexture
        - [x] 实现像素艺术图标生成器（PixelArtGenerator类）
          - [x] 创建 `PixelArtGenerator` 工具类
          - [x] 实现常见图案绘制（金矿、魔力水晶、食物巢穴、铁矿图标）
    - [x] 统一瓦块渲染颜色方案（建筑类型颜色、资源类型颜色）
  - [x] 规范化单位渲染
    - [x] 确保所有单位渲染为图片（Sprite2D节点）
    - [x] 单位图片路径规范：`img/units/<race>/<unit_name>.png`
    - [x] 实现单位图片加载和占位符机制
  - [x] 更新EntityRenderer确保渲染逻辑清晰
    - [x] 重构 `_create_resource_tile_visual()` 方法使用PixelArtGenerator + Sprite2D
    - [x] 移除圆形相关的代码（Polygon2D、圆形顶点生成等）
    - [x] 确保渲染性能优化（Sprite2D + 像素纹理比Polygon2D更高效）
  - [x] 验证渲染效果符合规范（瓦块=矩形，单位=图片）
    - [x] 测试金矿渲染为32x32像素金色矩形（代码已实现）
    - [x] 测试其他资源瓦块渲染为32x32像素矩形（代码已实现）
    - [ ] 测试渲染性能（确保流畅60FPS）- 需要运行时测试

- [x] **6.2 交互系统重构（基于Godot内置类）**
  - [x] 实现基于Area2D的交互检测系统
    - [x] 为资源瓦块添加Area2D节点（ResourceInteractable类，CollisionShape2D定义交互区域）
    - [ ] 为建筑瓦块添加Area2D节点（CollisionShape2D定义交互区域）- 可选，建筑系统阶段实现
    - [ ] 为单位添加Area2D节点（用于检测附近的交互对象）- 可选，后续实现
  - [x] 实现交互信号系统
    - [x] 使用Area2D的`body_entered`和`body_exited`信号
    - [x] 创建交互接口（Interactable接口），定义`interact(unit: Unit)`方法
    - [x] 实现交互组管理（使用Godot的Groups系统）
      - [x] 将所有可交互对象添加到"Interactable"组
      - [x] 实现按类型查找交互对象的功能（Resource_GOLD, Resource_IRON等组）
  - [x] 重构InteractionState使用新的交互系统
    - [x] ResourceInteractable已集成到EntityRenderer（资源瓦块有Area2D检测）
    - [x] InteractionState仍使用距离判断（但已兼容Area2D系统，支持多种资源类型）
    - [x] 保持与现有工作流的兼容性
  - [ ] 实现交互可视化
    - [ ] 交互范围内高亮显示（可选）
    - [ ] 交互进度显示（可选）

- [x] **6.3 资源系统扩展**
  - [x] 实现铁矿资源系统
    - [x] 实现铁矿资源瓦块（IronOreTile，类似GoldMineTile）
    - [x] 实现铁矿资源点地图生成（IronOreGenerator，生成15个铁矿）
    - [x] 实现铁矿挖矿工作流（单位可以挖铁矿，InteractionState支持IRON）
    - [ ] 实现矿坑存储铁矿（矿坑建筑存储铁矿）- 建筑系统待实现
  - [x] 实现食物资源瓦块系统
    - [x] 实现肉虫穴资源瓦块（MeatGrubNestTile）
    - [x] 实现食物资源点地图生成（FoodResourceGenerator，生成12个食物资源）
    - [x] 实现食物挖矿工作流（单位可以从食物资源瓦块挖掘食物，InteractionState支持FOOD）
  - [x] 扩展资源管理器支持铁矿资源类型
    - [x] ResourceManager已添加add_iron(), remove_iron(), get_iron()方法
    - [x] StoreResourceState已支持IRON资源存储
  - [ ] 实现资源流转系统（资源自动转移、资源消耗优先级）- 部分实现，待完善

- [x] **6.4 挖矿工作流实现**
  - [x] 实现挖矿工作流配置（支持金矿、铁矿、食物资源）
  - [x] 实现FindTarget查找资源点（金矿、铁矿、食物资源瓦块）
  - [x] 实现MoveToTarget移动到资源点
  - [x] 实现Interaction挖矿交互（支持多种资源类型，使用共享上下文动态设置）
  - [x] 实现FindStorage查找存储点（根据资源类型自动选择对应存储建筑）
  - [x] 实现StoreResource存储资源（支持多种资源类型：GOLD、IRON、FOOD、MANA）
  - [x] 注册哥布林工作流（挖矿工作流已更新为支持动态资源类型）

- [ ] **6.5 单位移动系统**
  - [x] 实现单位移动组件（已在第五阶段完成）
  - [x] 集成寻路系统到单位移动（已在第五阶段完成）
  - [ ] 实现移动动画（可选，视觉增强）

- [ ] **6.6 测试与验证**
  - [x] 测试项目结构重构后所有功能正常（代码已重构，编译通过）
  - [x] 测试新的交互系统工作正常（ResourceInteractable已集成）
  - [ ] 测试挖矿工作流完整循环（金矿、铁矿、食物资源瓦块）- 需要运行时测试
  - [ ] 测试资源流转系统（资源自动转移）- 需要运行时测试
  - [x] 验证渲染效果符合规范（代码已实现像素艺术渲染）
  - [ ] 性能测试确保流畅运行（需要运行时测试）

**依赖关系**：第五阶段

---

### 第七阶段：建筑系统与建造

**优先级**：高 ⭐⭐  
**目标**：实现建筑系统，地精作为建造工作流主体，能够建造和修复基础建筑  
**预计时间**：3-4周

**可运行目标**：
- 能够通过UI选择要建造的建筑
- 能够在地图上放置建筑（预览和验证）
- 地精能够自动寻找未完成的建筑并开始建造
- 地精能够自动寻找损坏的建筑并开始修复
- 地精能够移动到建筑位置并执行建造/修复工作
- 能够看到建造进度和完成效果
- 建造完成后建筑功能正常运作

**任务清单**：
- [ ] **7.1 建筑系统基础**
  - [ ] 实现所有19种建筑实体
  - [ ] 实现建筑资源存储系统
  - [ ] 实现建筑状态系统（未建造、建造中、完成、损坏）
  - [ ] 实现建筑管理器
  - [ ] 实现建筑需求系统（建造所需资源、时间）

- [ ] **7.2 地精单位实现**
  - [ ] 实现地精单位类（Goblin Engineer）
  - [ ] 配置地精基础属性（参考@单位属性配置表.md）
    - [ ] 生命值：150
    - [ ] 攻击力：8
    - [ ] 移动速度：55像素/秒
    - [ ] 其他完整属性配置
  - [ ] 实现地精在UnitManager中的生成逻辑
  - [ ] 确保地精能够被正确渲染和识别

- [ ] **7.3 建造系统核心**
  - [ ] 实现建筑放置验证（地形、冲突、可达性）
  - [ ] 实现建造流程系统（初始化、进行中、完成）
  - [ ] 实现建造进度跟踪（0-100%进度）
  - [ ] 实现建筑资源消耗验证

- [ ] **7.4 建造工作流配置**
  - [ ] 实现FindBuildingState（查找未完成/损坏的建筑）
    - [ ] 支持按建筑状态查找（建造中、损坏）
    - [ ] 支持按建筑类型查找
    - [ ] 实现搜索范围限制
  - [ ] 实现MoveToBuildingState（移动到建筑位置）
    - [ ] 集成寻路系统
    - [ ] 实现到达判断（距离建筑一定范围）
  - [ ] 实现BuildState（执行建造工作）
    - [ ] 实现建造进度更新
    - [ ] 实现资源消耗（从地牢之心或金库获取）
    - [ ] 实现建造完成检测
    - [ ] 支持建造时间配置
  - [ ] 实现RepairState（执行修复工作）
    - [ ] 实现修复进度更新
    - [ ] 实现资源消耗
    - [ ] 实现修复完成检测
  - [ ] 创建BuildWorkflow工作流配置
    - [ ] 状态序列：FindBuildingState → MoveToBuildingState → BuildState
    - [ ] 配置转换条件（成功/失败）
    - [ ] 设置工作流优先级（6，低于战斗但高于挖矿）
  - [ ] 创建RepairWorkflow工作流配置
    - [ ] 状态序列：FindBuildingState → MoveToBuildingState → RepairState
    - [ ] 配置转换条件
    - [ ] 设置工作流优先级（7，最高优先级之一）
  - [ ] 注册地精的工作流（BuildWorkflow, RepairWorkflow）
    - [ ] 在WorkflowRegistry中注册
    - [ ] 配置工作流触发条件（空闲时自动执行）
    - [ ] 配置工作流优先级（Repair > Build > Mining）

- [ ] **7.5 建造UI**
  - [ ] 实现建造面板UI
  - [ ] 实现建筑放置预览（可建造区域高亮）
  - [ ] 实现建筑信息显示（所需资源、建造时间）
  - [ ] 实现建造进度条显示（选择建筑时显示进度）
  - [ ] 实现地精工作状态显示（正在建造/修复的建筑）

- [ ] **7.6 基础存储建筑**
  - [ ] 实现金库（存储金币，500容量）
  - [ ] 实现肉库（存储食物）
  - [ ] 实现矿坑（存储铁矿等矿物）
  - [ ] 实现魔法祭坛（存储魔力，支持金币→魔力转化）
  - [ ] 实现武器库（存储装备，支持单位购买装备升级）
  - [ ] 实现资源转移逻辑（从地牢之心转移到存储建筑）
  - [ ] 实现存储可视化（显示存储资源数量）

- [ ] **7.7 建造工作流集成测试**
  - [ ] 测试地精能够找到未完成的建筑
  - [ ] 测试地精能够移动到建筑位置
  - [ ] 测试地精能够执行建造工作
  - [ ] 测试建造进度正确更新
  - [ ] 测试建造完成后建筑状态正确
  - [ ] 测试地精能够修复损坏的建筑
  - [ ] 测试多个地精能够同时建造不同建筑

**配置参考**：
- 地精属性配置参考：[单位属性配置表.md](docs/单位属性配置表.md) - 地精（Goblin Engineer）
- 工作流配置参考：[工作流配置系统.md](docs/工作流配置系统.md)
- 地精工作流优先级：Repair (7) → Build (6) → Mining (5)

**依赖关系**：第六阶段

---

### 第八阶段：单位训练与进化

**优先级**：高 ⭐⭐  
**目标**：实现单位训练和进化系统，完善所有22种单位的实现和属性配置  
**预计时间**：4-5周

**可运行目标**：
- 能够在地牢之心将哥布林进化为地精或兽人
- 能够在各建筑进行单位训练（训练所有21种可训练单位）
- 能够看到训练进度和完成效果
- 所有22种单位都已实现并配置了正确的属性
- 所有单位都能正确使用配置的属性（生命值、攻击力、移动速度等）

**任务清单**：
- [ ] **8.1 进化系统**
  - [ ] 实现哥布林→地精进化（地牢之心，消耗金币60秒）
  - [ ] 实现哥布林→兽人进化（地牢之心，消耗金币+魔力90秒）
  - [ ] 实现进化槽位管理
  - [ ] 实现进化进度显示
  - [ ] 实现进化资源消耗验证

- [ ] **8.2 训练系统**
  - [ ] 实现各建筑训练功能
    - [ ] 哨塔训练：哥布林斥候、哥布林战士
    - [ ] 酒馆训练：地精酒保、兽人打手
    - [ ] 铁匠铺训练：地精铁匠
    - [ ] 训练场训练：兽人系列单位
    - [ ] 竞技场训练：兽人角斗士
    - [ ] 狩猎场训练：兽人猎手系列
    - [ ] 驯兽塔训练：兽人驯兽师
    - [ ] 献祭塔训练：兽人萨满
  - [ ] 实现训练槽位管理
  - [ ] 实现训练进度显示
  - [ ] 实现训练资源消耗验证

- [ ] **8.3 装备资源系统**
  - [ ] 实现装备资源系统（装备类型、装备属性、装备存储）
  - [ ] 实现锻造场打造装备功能（地精铁匠消耗铁矿打造装备）
  - [ ] 实现武器库装备存储和购买功能
  - [ ] 实现单位装备购买和升级功能（兽人战士→重装战士、兽人猎手→劲弩猎手）

- [ ] **8.4 单位属性配置系统**
  - [ ] 实现统一单位属性配置类（UnitAttributes）
  - [ ] 实现属性配置注册表（UnitAttributesRegistry）
  - [ ] 实现属性验证系统（生命值必须是10的倍数等）
  - [ ] 实现自动计算衍生属性（远程单位追击范围=攻击范围）
  - [ ] 集成属性配置到单位实例化流程

- [ ] **8.5 功能类单位实现（4种）**
  - [ ] 1. 哥布林（Goblin）- ✅ 已实现（需配置属性）
  - [ ] 2. 地精（Goblin Engineer）
  - [ ] 3. 地精酒保（Goblin Bartender）
  - [ ] 4. 地精铁匠（Goblin Smith）
  - [ ] 为所有功能类单位配置完整属性（参考@单位属性配置表.md）

- [ ] **8.6 战斗类单位实现（18种）**
  - [ ] 5. 哥布林斥候（Goblin Scout）[远程]
  - [ ] 6. 哥布林战士（Goblin Warrior）
  - [ ] 7. 兽人（Orc）
  - [ ] 8. 兽人打手（Orc Bouncer）
  - [ ] 9. 兽人斥候（Orc Scout）
  - [ ] 10. 兽人猎手（Orc Hunter）[远程]
  - [ ] 11. 兽人劲弩猎手（Orc Crossbow Hunter）[远程]
  - [ ] 12. 兽人战士（Orc Warrior）
  - [ ] 13. 兽人重装战士（Orc Heavy Warrior）
  - [ ] 14. 兽人角斗士（Orc Gladiator）
  - [ ] 15. 兽人王牌斗士（Orc Elite Gladiator）
  - [ ] 16. 兽人冠军（Orc Champion）
  - [ ] 17. 兽人驯兽师（Orc Beastmaster）
  - [ ] 18. 兽人萨满（Orc Shaman）[魔法]
  - [ ] 为所有战斗类单位配置完整属性（参考@单位属性配置表.md）

- [ ] **8.7 野兽人召唤单位实现（4种）**
  - [ ] 19. 狼人（Werewolf）
  - [ ] 20. 巨魔（Troll）
  - [ ] 21. 牛头人（Minotaur）
  - [ ] 22. 半人马（Centaur）[远程]
  - [ ] 为所有野兽人单位配置完整属性（参考@单位属性配置表.md）
  - [ ] 实现献祭塔仪式召唤系统

- [ ] **8.8 单位属性完整配置**
  - [ ] 为所有22种单位配置以下属性：
    - [ ] 生命值（maxHealth，必须是10的倍数）
    - [ ] 攻击力（attackPower）
    - [ ] 攻击冷却（attackCooldown，秒）
    - [ ] 攻击范围（attackRange，像素）
    - [ ] 追击范围（pursuitRange，自动计算）
    - [ ] 护甲值（armorValue）
    - [ ] 体型大小（bodySize）
    - [ ] 移动速度（moveSpeed，像素/秒）
    - [ ] 是否为远程单位（isRanged，影响追击范围计算）
  - [ ] 确保所有属性值符合@单位属性配置表.md的数值
  - [ ] 实现属性应用到单位实例的机制

- [ ] **8.9 单位工作流配置**
  - [ ] 为所有22种单位配置基础工作流
  - [ ] 注册各单位的默认工作流（根据单位类型和功能）
  - [ ] 实现单位训练/进化后的工作流自动注册

**资源系统说明**：
- **基础资源**（第四阶段已完成）：金币、魔力、食物
- **铁矿系统**（第六阶段实现）：铁矿资源点类似金矿，单位挖矿后存储到矿坑，用于锻造场打造装备
- **食物资源瓦块**（第六阶段实现）：肉虫穴等食物资源瓦块，单位可以挖掘获得食物
- **装备系统**（第八阶段实现）：地精铁匠在锻造场消耗铁矿打造装备，装备存储在武器库，部分单位可购买升级
- **弹药说明**：弹药不是资源类型，而是箭塔建筑的属性/状态。地精消耗金币（资源）为箭塔补充弹药，弹药存储在箭塔内部（60发容量）

**配置参考**：
- 所有单位属性配置参考：[单位属性配置表.md](docs/单位属性配置表.md)
- 统一配置系统设计原则：所有单位使用相同的配置API和数据结构
- 属性验证规则：生命值必须是10的倍数，移动速度范围40-80像素/秒等
- 资源系统说明：详见项目计划中的"资源系统说明"章节

**依赖关系**：第七阶段

---

### 第九阶段：战斗系统

**优先级**：高 ⭐⭐  
**目标**：实现完整的战斗系统  
**预计时间**：3-4周

**可运行目标**：
- 能够生成敌对单位
- 单位能够自动战斗
- 能够看到战斗过程、伤害数值、单位死亡
- 能够看到生命值变化

**任务清单**：
- [ ] **9.1 战斗核心**
  - [ ] 实现战斗目标接口
  - [ ] 实现战斗攻击者接口
  - [ ] 实现战斗系统
  - [ ] 实现阵营系统

- [ ] **9.2 战斗机制**
  - [ ] 实现自动战斗
  - [ ] 实现攻击范围计算
  - [ ] 实现伤害计算
  - [ ] 实现死亡处理

- [ ] **9.3 遇敌行为**
  - [ ] 实现战斗工作流
  - [ ] 实现逃跑工作流
  - [ ] 注册所有单位的战斗/逃跑工作流

- [ ] **9.4 战斗可视化**
  - [ ] 实现攻击动画
  - [ ] 实现伤害数字显示
  - [ ] 实现生命值条
  - [ ] 实现死亡动画

**依赖关系**：第八阶段

---

### 第十阶段：完整单位与工作流

**优先级**：高 ⭐⭐  
**目标**：实现所有22种单位和17种工作流  
**预计时间**：4-5周

**可运行目标**：
- 能够训练和获取所有22种单位
- 每种单位都有完整的AI行为
- 能够看到各种工作流的执行过程

**任务清单**：
- [ ] **10.1 剩余单位实现**
  - [ ] 实现所有18种战斗类单位
  - [ ] 实现4种野兽人
  - [ ] 配置单位属性

- [ ] **10.2 完整工作流实现**
  - [ ] 实现所有17种工作流
  - [ ] 注册所有单位工作流
  - [ ] 配置工作流优先级和触发条件

- [ ] **10.3 特殊系统**
  - [ ] 实现购买装备系统
  - [ ] 实现竞技场晋级系统
  - [ ] 实现仪式召唤系统

**依赖关系**：第九阶段

---

### 第十一阶段：完整游戏循环

**优先级**：高 ⭐⭐  
**目标**：实现完整的游戏玩法循环  
**预计时间**：3-4周

**可运行目标**：
- 完整的资源循环
- 完整的单位循环
- 完整的建筑功能

**任务清单**：
- [ ] **11.1 资源循环优化**
  - [ ] 优化资源分配逻辑
  - [ ] 实现资源流转可视化
  - [ ] 实现资源短缺提示

- [ ] **11.2 建筑功能完善**
  - [ ] 实现所有建筑的特殊效果
  - [ ] 实现箭塔自动攻击
  - [ ] 实现警戒塔驻守系统
  - [ ] 实现酒馆消费系统

- [ ] **11.3 AI优化**
  - [ ] 优化任务分配算法
  - [ ] 实现智能建筑关联

**依赖关系**：第十阶段

---

### 第十六阶段：优化与打磨

**优先级**：高 ⭐⭐  
**目标**：性能优化、bug修复、用户体验优化  
**预计时间**：2-3周

**任务清单**：
- [ ] **16.1 性能优化**
  - [ ] 渲染优化
  - [ ] 内存管理
  - [ ] 批量操作优化

- [ ] **16.2 Bug修复**
  - [ ] 修复所有已知bug
  - [ ] 修复工作流问题
  - [ ] 修复UI问题

- [ ] **16.3 用户体验**
  - [ ] 优化操作流畅度
  - [ ] 优化提示信息
  - [ ] 优化教程引导

**依赖关系**：第十四或第十五阶段

---

## 🔶 中优先级阶段

### 第十二阶段：UI系统完善

**优先级**：中 ⭐  
**目标**：实现完整的UI系统  
**预计时间**：3-4周

**任务清单**：
- [ ] **12.1 UI核心**
  - [ ] 实现UI面板基类
  - [ ] 实现UI管理器
  - [ ] 实现UI动画系统

- [ ] **12.2 游戏主UI**
  - [ ] 实现资源显示UI
  - [ ] 实现建造面板UI
  - [ ] 实现建筑信息UI
  - [ ] 实现单位信息UI

- [ ] **12.3 图鉴系统**
  - [ ] 实现单位图鉴面板
  - [ ] 实现建筑图鉴面板
  - [ ] 实现筛选和搜索功能

**依赖关系**：第十一阶段

---

### 第十三阶段：特效与美化

**优先级**：中 ⭐  
**目标**：实现特效系统和视觉美化  
**预计时间**：2-3周

**任务清单**：
- [ ] **13.1 特效系统**
  - [ ] 实现对象池系统
  - [ ] 实现投射物系统
  - [ ] 实现粒子特效系统

- [ ] **13.2 特效集成**
  - [ ] 攻击特效
  - [ ] 建造特效
  - [ ] 资源特效
  - [ ] 技能特效

**依赖关系**：第十二阶段

---

### 第十四阶段：英雄AI与挑战

**优先级**：中 ⭐  
**目标**：实现英雄AI系统，增加游戏挑战  
**预计时间**：2-3周

**任务清单**：
- [ ] **14.1 英雄AI**
  - [ ] 实现英雄AI系统
  - [ ] 实现入侵行为
  - [ ] 实现目标优先级

- [ ] **14.2 监狱系统**
  - [ ] 实现监狱建筑
  - [ ] 实现俘虏管理
  - [ ] 实现俘虏送到竞技场

**依赖关系**：第十三阶段

---

## 🔸 低优先级阶段

### 第十五阶段：高级功能与扩展

**优先级**：低 🔸  
**目标**：实现高级功能和内容扩展  
**预计时间**：3-4周

**任务清单**：
- [ ] **15.1 音效系统**
  - [ ] 实现音频管理器
  - [ ] 添加背景音乐
  - [ ] 添加音效（建造、战斗、采集等）

- [ ] **15.2 地图扩展**
  - [ ] 实现房间生成系统
  - [ ] 实现迷宫生成系统
  - [ ] 实现生态系统内容

- [ ] **15.3 保存加载**
  - [ ] 实现地图保存
  - [ ] 实现游戏存档
  - [ ] 实现存档管理

**依赖关系**：第十四阶段

---

## 总体时间估算

| 阶段           | 可运行目标           | 预计时间    | 优先级 | 可视化内容                           |
| -------------- | -------------------- | ----------- | ------ | ------------------------------------ |
| **阶段0**      | 初始化环境           | 1周         | ⭐⭐⭐    | 项目基础结构                         |
| **第一阶段**   | 可视化Demo           | 3-4周       | ⭐⭐⭐    | 地形、空洞、通道                     |
| **第二阶段**   | 寻路系统             | 2-3周       | ⭐⭐     | 路径可视化                           |
| **第三阶段**   | 地图渲染与相机系统   | 1-2周       | ⭐⭐⭐    | 现代化渲染、WASD相机控制             |
| **第四阶段**   | 基础实体与资源       | 3-4周       | ⭐⭐     | 地牢之心、金矿、哥布林               |
| **第五阶段**   | 状态机系统           | 4-5周       | ⭐⭐     | 状态转换、工作流、单位图鉴           |
| **第六阶段**   | 挖矿工作流           | 2-3周       | ⭐⭐     | 挖矿循环、金币增加                   |
| **第七阶段**   | 建造系统             | 3-4周       | ⭐⭐     | 建造进度、建筑完成                   |
| **第八阶段**   | 单位训练与进化       | 4-5周       | ⭐⭐     | 训练进度、进化效果、22种单位完整实现 |
| **第九阶段**   | 战斗系统             | 3-4周       | ⭐⭐     | 战斗过程、伤害、死亡                 |
| **第十阶段**   | 完整单位与工作流     | 4-5周       | ⭐⭐     | 各种工作流执行                       |
| **第十一阶段** | 完整游戏循环         | 3-4周       | ⭐⭐     | 资源循环、单位循环、建筑功能         |
| **第十二阶段** | UI系统               | 3-4周       | ⭐      | UI界面、图鉴                         |
| **第十三阶段** | 特效系统             | 2-3周       | ⭐      | 攻击特效、粒子效果                   |
| **第十四阶段** | 英雄AI与挑战         | 2-3周       | ⭐      | 英雄入侵、防御战斗                   |
| **第十五阶段** | 高级功能扩展（可选） | 3-4周       | 🔸      | 音效、地图扩展                       |
| **第十六阶段** | 优化与打磨           | 2-3周       | ⭐⭐     | 性能优化、bug修复                    |
| **合计**       | **完整可玩游戏**     | **42-57周** | -      | 渐进式完整功能                       |

**保守估计完成时间**：约1-1.35年（全职开发）

---

## 关键依赖关系图

```
阶段0（初始化环境）
  ↓
第一阶段（可视化Demo）
  ↓
第二阶段（寻路系统）
  ↓
第三阶段（地图渲染与相机系统）
  ↓
第四阶段（基础实体） ← 第三阶段
  ↓
第五阶段（状态机） ← 第四阶段
  ↓
第六阶段（挖矿） ← 第五阶段
  ↓
第七阶段（建造） ← 第六阶段
  ↓
第八阶段（训练） ← 第七阶段
  ↓
第九阶段（战斗） ← 第八阶段
  ↓
第十阶段（完整单位） ← 第九阶段
  ↓
第十一阶段（游戏循环） ← 第十阶段
  ↓
第十二阶段（UI） ← 第十一阶段
  ↓
第十三阶段（特效） ← 第十二阶段
  ↓
第十四阶段（英雄AI） ← 第十三阶段
  ↓
第十五阶段（扩展） ← 第十四阶段（可选）
  ↓
第十六阶段（优化） ← 第十四或第十五阶段
```

---

## 资源系统说明

### 资源类型总览

MazeMaster2D 游戏包含5种资源类型，分为三大类别：**基础资源**（3种，第四阶段已完成）、**消耗品**（1种）和**装备**（1种）。

| 资源类型 | 分类     | 获取方式                             | 存储建筑             | 主要用途                                 |
| -------- | -------- | ------------------------------------ | -------------------- | ---------------------------------------- |
| **金币** | 基础资源 | 挖矿（金矿）、交易                   | 地牢之心、金库、酒馆 | 建造、训练、进化、购买、补充弹药（箭塔） |
| **魔力** | 基础资源 | 魔法祭坛转化、自然恢复               | 地牢之心、魔法祭坛   | 进化、仪式召唤、萨满技能                 |
| **食物** | 基础资源 | 多种资源瓦块（肉虫穴等）、狩猎、交易 | 地牢之心、肉库、酒馆 | 单位生存、酒馆消费、训练消耗             |
| **铁矿** | 消耗品   | 挖矿（铁矿资源点）、地图生成         | 矿坑                 | 锻造场打造装备                           |
| **装备** | 装备     | 锻造场打造、武器库购买               | 武器库               | 单位升级（战士→重装战士、猎手→劲弩猎手） |

**注意**：弹药不是资源类型，而是箭塔建筑的属性/状态。箭塔通过消耗金币（资源）来补充弹药，弹药存储在箭塔内部，作为箭塔的攻击能力限制。

### 资源详细说明

#### 1. 基础资源

**1.1 金币（GOLD）**
- **获取方式**：
  - 挖矿：哥布林从金矿资源点挖掘获得
  - 交易：单位消费金币购买其他资源
- **存储建筑**：
  - 地牢之心：无限容量（主存储）
  - 金库：500容量（辅助存储）
  - 酒馆：500容量（同时用于消费）
- **主要用途**：
  - 建造建筑：消耗金币建造各种建筑
  - 训练单位：在各训练建筑消耗金币训练单位
  - 进化单位：在地牢之心、地精巢穴、兽人巢穴消耗金币进化单位
  - 补充弹药：地精消耗金币为箭塔补充弹药（1金币=1弹药）
  - 购买食物：单位在酒馆消费金币购买食物（1金币=1食物）
  - 购买装备：部分单位在武器库消费金币购买装备（升级）
  - 转化魔力：在魔法祭坛消耗金币转化为魔力

**1.2 魔力（MANA）**
- **获取方式**：
  - 魔法祭坛转化：消耗金币转化为魔力（转化比例待定）
  - 自然恢复：地牢之心和魔法祭坛可能具有自然恢复能力（待定）
- **存储建筑**：
  - 地牢之心：1000容量（主存储）
  - 魔法祭坛：存储容量待定（辅助存储）
- **主要用途**：
  - 进化单位：在兽人巢穴、地精巢穴消耗魔力进化哥布林→兽人/地精
  - 仪式召唤：兽人萨满在献祭塔消耗魔力举行仪式，召唤野兽人单位（狼人、巨魔、牛头人、半人马）
  - 萨满技能：兽人萨满使用魔力释放技能

**1.3 食物（FOOD）**
- **获取方式**：
  - **资源瓦块挖掘**：单位从多种食物资源瓦块中挖掘获得
    - 肉虫穴（MeatGrubNest）：主要食物资源瓦块，类似金矿
    - 其他食物资源瓦块（待扩展）
  - 狩猎：兽人猎手狩猎野兽，在狩猎塔分解为食物
  - 交易：单位在酒馆消费金币购买食物（1金币=1食物）
- **存储建筑**：
  - 地牢之心：无限容量（主存储）
  - 肉库：存储容量待定（辅助存储）
  - 酒馆：500容量（同时用于消费）
- **主要用途**：
  - 单位生存：单位需要食物维持生存（待实现）
  - 酒馆消费：所有单位可以在酒馆消费金币购买食物
  - 训练消耗：部分训练可能消耗食物（待定）

#### 2. 消耗品资源

**2.1 铁矿（IRON/ORE）**
- **获取方式**：
  - 挖矿：单位从铁矿资源点挖掘获得（类似金矿）
  - 地图生成：在地图上生成铁矿资源点
- **存储建筑**：
  - 矿坑：存储容量待定（各种矿物统一存储）
- **主要用途**：
  - 锻造装备：地精铁匠在锻造场消耗铁矿打造装备
  - 装备类型：各种武器和防具（具体类型待定）
  - 装备产出：打造好的装备存储在武器库中

#### 3. 装备资源

**3.1 装备（EQUIPMENT）**
- **获取方式**：
  - 锻造场打造：地精铁匠消耗铁矿打造装备
  - 武器库购买：部分单位消费金币在武器库购买装备（升级）
- **存储建筑**：
  - 武器库：存储容量待定（装备专用存储）
- **主要用途**：
  - 单位升级：部分单位在武器库购买装备后可以升级
    - 兽人战士 → 兽人重装战士（购买重装装备）
    - 兽人猎手 → 兽人劲弩猎手（购买劲弩装备）
  - 装备属性：装备可能提供属性加成（攻击力、护甲值等，待定）

### 资源流转系统

**资源流转路径**：
1. **金币挖矿循环**：哥布林挖金矿 → 存储到地牢之心/金库 → 用于建造/训练/进化/补充箭塔弹药
2. **魔力循环**：金币 → 魔法祭坛转化 → 魔力 → 用于进化/仪式召唤
3. **食物循环**：
   - 挖矿路径：单位挖肉虫穴等食物资源瓦块 → 存储到肉库/地牢之心
   - 狩猎路径：兽人猎手狩猎野兽 → 狩猎塔分解 → 食物 → 存储到肉库/地牢之心
   - 交易路径：单位在酒馆消费金币购买食物
4. **装备循环**：铁矿资源点 → 单位挖矿 → 存储到矿坑 → 锻造场打造 → 装备 → 武器库存储 → 单位购买升级

**注意**：弹药不是资源，而是箭塔的状态。地精消耗金币（资源）为箭塔补充弹药，弹药作为箭塔的攻击能力限制存储在箭塔内部。

### 资源管理机制

**资源存储优先级**：
- 地牢之心作为主存储，拥有最大容量（部分资源无限）
- 其他存储建筑作为辅助存储，分散资源分布
- 单位可以自动将资源从地牢之心转移到其他存储建筑

**资源消耗优先级**：
- 建造/修复：最高优先级（地精建造和修复工作流）
- 战斗相关：高优先级（箭塔补充弹药消耗金币、战斗消耗）
- 训练/进化：中优先级（单位训练和进化）
- 消费：低优先级（单位在酒馆购买食物）

**资源可视化**：
- UI显示：实时显示当前资源数量（金币、魔力、食物，后续添加铁矿和装备）
- 建筑显示：显示建筑存储的资源数量
- 资源流动：可视化资源转移过程（可选）

**弹药系统说明**（非资源类型）：
- 弹药是箭塔建筑的内部状态，不是游戏资源
- 箭塔内置60发弹药容量，弹药耗尽时停止攻击
- 地精可以消耗金币（资源）为箭塔补充弹药（1金币=1弹药）
- 弹药作为箭塔的攻击能力限制，存储在箭塔内部，不能转移到其他建筑

---

## 配置系统说明

### 统一配置API

项目使用统一的配置API实现两个关键功能：

1. **工作流构建API**：
   - 所有工作流使用统一的配置结构创建
   - 支持参数化配置、转换条件、上下文数据
   - 详见：[工作流配置系统.md](docs/工作流配置系统.md)

2. **单位工作流注册API**：
   - 所有单位使用统一的注册接口关联多个工作流
   - 支持优先级、触发条件、中断规则配置
   - 新增单位只需创建工作流+注册工作流

### 配置优势

- **统一管理**：所有配置使用统一结构
- **易于扩展**：新增单位无需修改系统代码
- **配置驱动**：通过配置文件而非硬编码
- **灵活组合**：状态机可被多个工作流复用

详细配置说明请参见：
- [工作流配置系统.md](docs/工作流配置系统.md) - 工作流配置和API
- [单位属性配置表.md](docs/单位属性配置表.md) - 单位属性配置系统
- [建筑系统.md](docs/建筑系统.md) - 建筑配置
- [单位系统.md](docs/单位系统.md) - 单位配置

---

## 当前进度

### 项目状态：🚧 开发中（第六阶段大部分完成）

**当前阶段**：第六阶段（挖矿工作流与基础AI）大部分完成 ✅（约85%完成）

**已完成内容**：
- ✅ 阶段0：初始化环境
  - ✅ 项目结构创建（Godot项目、目录结构）
  - ✅ 枚举和常量定义（TerrainType、CavityType等）
  - ✅ 管理器基类（单例模式）
  - ✅ 空洞数据结构

- ✅ 第一阶段：可视化Demo
  - ✅ 200x200网格地图系统（瓦块大小32x32像素）
  - ✅ 地形管理器（二维数组存储）
  - ✅ 瓦块管理系统（Tile类、TileManager、属性自动计算）
  - ✅ 网格坐标系统（坐标转换、对齐、验证）
  - ✅ 空洞系统（关键、功能、生态三种类型）
  - ✅ 泊松圆盘分布算法（Bridson算法、网格加速）
  - ✅ 基于噪声的空洞形状生成（HoleShapeGenerator，参考 MazeMaster3D）
    - ✅ 噪声形状（NOISE）：多层噪声扰动
    - ✅ 有机形状（ORGANIC）：5层噪声叠加
  - ✅ 地图生成流程（关键空洞、功能空洞20个、生态空洞15个）
  - ✅ Bresenham线算法（通道生成，已禁用）
  - ✅ 基础渲染功能（地形渲染、空洞可视化）
  - ✅ UI控制（重新生成按钮、地图信息显示）

- ✅ 第二阶段：寻路系统
  - ✅ A*核心算法（AStarPathfinding类）
  - ✅ AStarGrid2D集成（GridPathfinding类）
  - ✅ 混合寻路策略（优先AStarGrid2D，后备A*算法）
  - ✅ DFS后备算法（DFSPathfinding类）
  - ✅ PathfindingManager寻路管理器
  - ✅ 路径缓存系统（可选优化）
  - ✅ 路径可视化（PathVisualizer类）
  - ✅ 起点/终点标记（绿色/红色显示）
  - ✅ 鼠标点击交互（Main.gd集成）
  - ✅ Open/Closed列表优化
  - ✅ 曼哈顿距离启发式函数

- ✅ 第三阶段：地图渲染与相机系统
  - ✅ CameraController相机控制器（Camera2D继承）
  - ✅ WASD键盘输入映射
  - ✅ 相机移动平滑插值（position_smoothing）
  - ✅ 相机边界限制
  - ✅ 鼠标滚轮缩放功能
  - ✅ 平滑缩放过渡（目标缩放值插值系统）
  - ✅ 扩大缩放范围（min_zoom: 0.05, max_zoom: 3.0）
  - ✅ 优化缩放增量（zoom_speed: 0.01）
  - ✅ TileMap地形渲染器（替代ColorRect）
  - ✅ 精确颜色值定义（深灰/浅灰/中灰）
  - ✅ 运行时TileSet资源创建
  - ✅ TileSet tile_size设置（32x32瓦块大小统一配置）
  - ✅ CavityVisualizer坐标计算修复（移除错误的 /2 操作）
  - ✅ 延迟初始化AStarGrid2D优化
  - ✅ 相机世界坐标转换集成
  - ✅ 增大空洞生成尺寸（4x4, 8x8, 12x12）
- ✅ 空洞重叠检测系统（防止重复生成）
- ✅ 更新大小分类标准（面积阈值：30, 100）

- ✅ 第四阶段：基础实体与资源系统
  - ✅ Tile-based架构重构（ResourceTile、BuildingTile继承体系）
  - ✅ 资源瓦块系统（ResourceTile基类、GoldMineTile、TileManager集成）
  - ✅ 建筑瓦块系统（BuildingTile基类、DungeonHeartTile、建筑放置验证）
  - ✅ 单位继承体系（Unit基类、Monster/Hero/Beast基类、Goblin单位）
  - ✅ 实体管理器（EntityManager、UnitManager、ResourceManager）
  - ✅ 资源系统（ResourceContainer、整数资源系统：金币、魔力、食物）
  - ✅ 实体渲染系统（EntityRenderer从Tile读取建筑和资源数据，独立渲染单位）
  - ✅ 地图资源生成（GoldMineGenerator、MapGenerator集成，地图任意位置生成金矿）
  - ✅ 基础UI系统（ResourceUI资源显示、DebugPanel简单控制面板、单位图片渲染）
  - ✅ 渲染层级优化（z_index设置，确保资源显示在地形之上）

**技术亮点**：
- 实现了完整的离散网格单元系统，每个位置都是独立的Tile对象
- 采用二维数组存储，支持高效查询和批量操作
- 集成FastNoiseLite实现自然的随机空洞形状
- 参考MazeMaster3D的空洞生成策略，优先使用有机形状
- 实现了混合寻路策略：AStarGrid2D快速寻路 + A*算法精确移动
- DFS算法作为后备，确保在任何情况下都能找到可达路径
- 完整的路径可视化系统，支持实时交互测试
- 使用TileMap替代ColorRect，性能大幅提升（40,000瓦块流畅渲染）
- TileSet tile_size统一配置为32x32，确保瓦块尺寸一致性
- Camera2D平滑移动和缩放，现代化视觉体验
- 平滑缩放过渡系统（目标缩放值插值，zoom_smooth_speed控制）
- 扩大缩放范围支持查看完整地图（min_zoom: 0.05, max_zoom: 3.0）
- 空洞重叠检测系统，确保地图生成质量
- 实现了完整的Tile-based架构，建筑和资源作为瓦块类型存储在Tile中
- 单位继承体系（Unit → Monster/Hero/Beast），哥布林继承自Hero
- EntityRenderer使用图片渲染单位（`img/Monster/哥布林.png`）
- 渲染层级系统（TerrainRenderer z_index=0, EntityRenderer z_index=10）
- 简单控制面板（卡片式设计，显示单位图片和召唤按钮）
- **工作流驱动状态转换架构**：状态类返回StateResult，WorkflowExecutor主动控制状态转换
- **共享上下文系统**：通过shared_context实现状态间数据传递，解决数据丢失问题
- **状态可视化系统**：单位右上角空心矩形状态指示器，动态颜色显示当前状态（26种状态颜色映射）
- **工作流可视化系统**：在状态指示器下方实时显示工作流名称和进度（如"MiningWorkflow 2/4"）
- **状态转换动画增强**：ease-in-out缓动、闪烁效果、缩放动画、边框加粗动画
- **单位图鉴系统完整实现**：所有22种单位完整数据（9项属性）、详细信息展示、头像显示、性能优化
- **基于速度的平滑移动系统**：双坐标系统（网格坐标+世界坐标），每帧移动speed*delta像素，自动同步
- **单位速度配置系统**：以瓦块/秒为单位（便于后续调整瓦块大小），基准1瓦块/秒=32像素/秒，所有22种单位速度已配置

**当前阶段进度**：
- ✅ **第五阶段：状态机与工作流系统（100%完成）**
  - ✅ 状态机核心框架已完成
  - ✅ 20种基础状态机全部实现
  - ✅ 工作流系统核心已完成
  - ✅ 哥布林工作流已配置并运行
  - ✅ 状态可视化系统已集成（状态指示器正常工作）
  - ✅ 工作流可视化已实现（显示工作流名称和进度）
  - ✅ 状态转换动画增强已实现（缓动、闪烁、缩放、边框动画）
  - ✅ 单位图鉴系统完整实现：
    - 所有22种单位完整数据（9项属性配置）
    - 详细信息展示（属性网格、工作流列表）
    - 单位头像显示（图片加载和占位符）
    - 性能优化（头像缓存、列表缓存）
  - ✅ 单位图鉴快捷键已集成（B键打开/关闭）
  - ✅ 基于速度的平滑移动系统已实现（双坐标系统）
  - ✅ 单位速度配置系统已完善（瓦块/秒格式，所有22种单位已配置）

**当前阶段进度**：
- ✅ **第六阶段：挖矿工作流与基础AI（约85%完成）**
  - ✅ 项目结构重构已完成
  - ✅ 渲染系统规范化已完成（像素艺术渲染系统）
  - ✅ 交互系统重构已完成（ResourceInteractable + Area2D）
  - ✅ 资源系统扩展已完成（铁矿、食物资源瓦块）
  - ✅ 挖矿工作流实现已完成（支持多种资源类型）
  - ✅ 单位移动系统已完成（第五阶段）
  - ⏳ 测试与验证：代码实现完成，需要运行时测试验证

**下一步行动**：
- 🚀 完成第六阶段测试与验证（运行时测试）
- 🚀 开始第七阶段：建筑系统与建造

---

*最后更新：2025-01-22（第六阶段约85%完成：项目结构重构、像素艺术渲染系统、交互系统重构、资源系统扩展、挖矿工作流实现已完成；测试与验证待运行时测试）*