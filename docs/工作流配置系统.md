# 工作流配置系统

## 概述

工作流配置系统定义了游戏中各种单位的自动化行为模式。系统采用模块化设计，将工作流的各个步骤提取为独立、可复用的基础状态机。这些状态机可以像积木一样拼接组合，形成完整的工作流配置。

### 核心设计原则

⚠️ **统一配置与API**：

1. **工作流构建API**：所有工作流使用统一的配置结构创建
2. **单位工作流注册API**：所有单位使用统一的注册接口关联多个工作流
3. **配置驱动**：通过配置文件（而非硬编码）驱动工作流逻辑
4. **可扩展性**：新增单位只需创建工作流+注册工作流，无需修改系统代码

---

## 配置系统设计

### 工作流构建配置

所有工作流使用统一的配置结构：

```yaml
Workflow:
  name: "工作流名称"           # 唯一标识
  priority: 优先级数值        # 10=最高, 1=最低
  interruptible: true/false   # 是否可被高优先级中断
  
  states:                     # 状态序列
    - state: "StateName"      # 状态机类名
      params:                 # 状态参数
        key1: value1
        key2: value2
      transitions:            # 转换条件
        success: "NextState"  # 成功后转到的状态
        failure: "ErrorState" # 失败后转到的状态
        condition:            # 自定义条件
          check: "逻辑表达式"
          true: "TrueState"
          false: "FalseState"
  
  context:                    # 上下文数据
    input: ["data1", "data2"] # 需要的输入数据
    output: "result"          # 输出结果存储键
```

### 单位工作流注册配置

所有单位使用统一的注册结构：

```yaml
UnitWorkflow:
  unitType: "单位类型"        # 哥布林、地精、兽人等
  
  workflows:                  # 工作流列表
    - name: "工作流A"
      priority: 10
      trigger: "发现敌人"     # 触发条件
      interrupt: true         # 中断其他
      
    - name: "工作流B"
      priority: 5
      trigger: "空闲时"
      interrupt: false
```

---

## 工作流覆盖度总览

**工作流覆盖度**：100% ✅  
所有22种单位都有对应的工作流配置，核心功能完整实现。

**配置完整度**：55% ⚠️  
大部分配置完整，但需要补充时间比例和一些建筑关联细节。

| 分类     | 单位数量 | 完全匹配 | 需补充配置 |
| -------- | -------- | -------- | ---------- |
| 功能类   | 4种      | 4种      | 0种        |
| 战斗类   | 18种     | 8种      | 10种       |
| **总计** | **22种** | **12种** | **10种**   |

---

## 基础状态机库（20种）

### 状态指示器设计

**视觉规范**：
- **位置**：单位渲染右上角（相对于单位中心点偏移）
- **形状**：长方体空心矩形（边框矩形，不填充）
- **尺寸**：建议 8x12 像素（宽度x高度）
- **样式**：空心边框，边框宽度 2 像素
- **颜色**：根据当前状态动态变化

**状态颜色配置**：

| 状态类型                      | 颜色 | RGB值              | 说明                     |
| ----------------------------- | ---- | ------------------ | ------------------------ |
| **IdleState**                 | 黄色 | RGB(255, 255, 0)   | 空闲状态，等待任务       |
| **FindTargetState**           | 青色 | RGB(0, 255, 255)   | 正在查找目标资源         |
| **FindStorageState**          | 浅蓝 | RGB(173, 216, 230) | 正在查找存储建筑         |
| **FindNearestEnemyState**     | 粉红 | RGB(255, 192, 203) | 正在查找敌人             |
| **MoveToTargetState**         | 蓝色 | RGB(0, 0, 255)     | 正在移动向目标           |
| **MoveToPositionState**       | 深蓝 | RGB(0, 0, 139)     | 正在移动到指定位置       |
| **PatrolToPointState**        | 紫色 | RGB(128, 0, 128)   | 正在巡逻到点             |
| **MoveAwayFromTargetState**   | 橙红 | RGB(255, 69, 0)    | 正在远离目标（逃跑中）   |
| **InteractionState**          | 绿色 | RGB(0, 255, 0)     | 正在交互（挖矿、建造等） |
| **AttackState**               | 红色 | RGB(255, 0, 0)     | 正在攻击                 |
| **TakeResourceState**         | 浅绿 | RGB(144, 238, 144) | 正在拿取资源             |
| **StoreResourceState**        | 青绿 | RGB(0, 255, 127)   | 正在存储资源             |
| **TransferResourceState**     | 黄绿 | RGB(154, 205, 50)  | 正在转移资源             |
| **WaitState**                 | 灰色 | RGB(128, 128, 128) | 等待中                   |
| **CheckConditionState**       | 浅灰 | RGB(211, 211, 211) | 检查条件中               |
| **CheckStorageCapacityState** | 银灰 | RGB(192, 192, 192) | 检查存储容量             |
| **CheckTargetStatusState**    | 暗灰 | RGB(169, 169, 169) | 检查目标状态             |
| **PatrolState**               | 紫红 | RGB(255, 0, 255)   | 巡逻中                   |
| **GuardState**                | 棕色 | RGB(165, 42, 42)   | 守卫中                   |
| **FleeState**                 | 橙色 | RGB(255, 165, 0)   | 逃跑中（紧急）           |

**特殊状态颜色**（扩展状态，如有实现）：
- **BuildState**：金绿色 RGB(0, 200, 100) - 建造中
- **RepairState**：金色 RGB(255, 215, 0) - 修复中
- **CraftState**：古铜色 RGB(184, 115, 51) - 打造中
- **ServiceState**：品红 RGB(255, 0, 255) - 服务中
- **HuntState**：深绿 RGB(0, 100, 0) - 狩猎中
- **TameState**：靛蓝 RGB(75, 0, 130) - 驯服中

**颜色编码原则**：
- **黄色系**：空闲、等待状态
- **蓝色系**：移动、查找状态
- **绿色系**：交互、采集状态
- **红色系**：战斗、紧急状态
- **紫色系**：巡逻、特殊状态
- **灰色系**：检查、判断状态

### 查找类（3种）

| 状态机                    | 功能         | 参数                         | 指示器颜色              |
| ------------------------- | ------------ | ---------------------------- | ----------------------- |
| **FindTargetState**       | 查找目标     | 目标类型、搜索范围、过滤条件 | 青色 RGB(0, 255, 255)   |
| **FindStorageState**      | 查找存储点   | 存储点类型、资源类型要求     | 浅蓝 RGB(173, 216, 230) |
| **FindNearestEnemyState** | 查找最近敌人 | 警戒范围、敌对阵营           | 粉红 RGB(255, 192, 203) |

### 移动类（4种）

| 状态机                      | 功能       | 参数               | 指示器颜色            |
| --------------------------- | ---------- | ------------------ | --------------------- |
| **MoveToTargetState**       | 移动到目标 | 目标引用、交互范围 | 蓝色 RGB(0, 0, 255)   |
| **MoveToPositionState**     | 移动到位置 | 目标坐标、到达阈值 | 深蓝 RGB(0, 0, 139)   |
| **PatrolToPointState**      | 巡逻至点   | 巡逻路径、循环模式 | 紫色 RGB(128, 0, 128) |
| **MoveAwayFromTargetState** | 远离目标   | 逃跑距离、逃跑方向 | 橙红 RGB(255, 69, 0)  |

### 交互类（5种）

| 状态机                    | 功能     | 参数                          | 指示器颜色              |
| ------------------------- | -------- | ----------------------------- | ----------------------- |
| **InteractionState**      | 通用交互 | 交互类型、速度、资源消耗/产出 | 绿色 RGB(0, 255, 0)     |
| **AttackState**           | 攻击     | 攻击范围、攻击力、冷却        | 红色 RGB(255, 0, 0)     |
| **TakeResourceState**     | 拿取资源 | 资源类型、获取数量            | 浅绿 RGB(144, 238, 144) |
| **StoreResourceState**    | 存储资源 | 资源类型、存储点              | 青绿 RGB(0, 255, 127)   |
| **TransferResourceState** | 转移资源 | 资源类型、转移数量            | 黄绿 RGB(154, 205, 50)  |

### 等待检查类（6种）

| 状态机                        | 功能         | 参数               | 指示器颜色              |
| ----------------------------- | ------------ | ------------------ | ----------------------- |
| **WaitState**                 | 等待         | 等待时间、等待条件 | 灰色 RGB(128, 128, 128) |
| **CheckConditionState**       | 条件检查     | 检查条件、分支映射 | 浅灰 RGB(211, 211, 211) |
| **CheckStorageCapacityState** | 检查容量     | 容量阈值、比较类型 | 银灰 RGB(192, 192, 192) |
| **CheckTargetStatusState**    | 检查目标状态 | 检查属性、状态阈值 | 暗灰 RGB(169, 169, 169) |
| **PatrolState**               | 巡逻         | 巡逻区域、循环模式 | 紫红 RGB(255, 0, 255)   |
| **GuardState**                | 守卫         | 守卫位置、扫描范围 | 棕色 RGB(165, 42, 42)   |

### 行为类（2种）

| 状态机        | 功能 | 参数                   | 指示器颜色            |
| ------------- | ---- | ---------------------- | --------------------- |
| **IdleState** | 空闲 | 空闲时间、自动寻找任务 | 黄色 RGB(255, 255, 0) |
| **FleeState** | 逃跑 | 逃跑距离、安全区域     | 橙色 RGB(255, 165, 0) |

---

## 完整工作流定义

### 工作流流程图说明

使用 `A →[条件]→ B →[条件]→ C` 格式表示工作流流程：
- **大写字母**：状态机（State）
- **[中括号]**：转换条件
- **循环**：使用虚线表示

---

## 功能类单位工作流

### 哥布林

```
[哥布林]
  └─ 逃跑工作流 (优先级10) ━━━━━━━━━━━━━━► [战斗单位]
  └─ 挖矿工作流 (优先级5)
       │
       ├─ 找矿 →[找到]→ 移动 →[到达]→ 挖矿
       │                ↓
       │              [失败]→ 等待 → 重试
       │
       ├─ [满载]→ 找金库 →[找到]→ 移动 →[到达]→ 存矿
       │                            ↓
       │                          [已满]→ 找其他金库
       │
       └─ [完成]→ 循环
```

**配置示例**：
```yaml
Unit: 哥布林
Workflows:
  - 挖矿工作流 (优先级5)
  - 逃跑工作流 (优先级10)
```

---

### 地精

```
[地精]
  └─ 逃跑工作流 (优先级10) ━━━━━━━━━━━━━━► [战斗单位]
  └─ 修复工作流 (优先级7)
       │
       ├─ 找受损建筑 →[找到]→ 检查资源
       │                     ↓
       │              [足够]→ 移动 →[到达]→ 修复
       │              [不足]→ 找金库 → 拿资源 → 返回
       │
       └─ [完成]→ 循环
       
  └─ 建造工作流 (优先级6)
       │
       ├─ 找未完成建筑 →[找到]→ 检查资源
       │                      ↓
       │               [足够]→ 移动 →[到达]→ 建造
       │               [不足]→ 找金库 → 拿资源 → 返回
       │
       └─ [完成]→ 循环
       
  └─ 装填工作流 (优先级5)
       │
       ├─ 找箭塔(无弹药) →[找到]→ 检查资源
       │                      ↓
       │               [足够]→ 移动 →[到达]→ 装填
       │               [不足]→ 找金库 → 拿资源 → 返回
       │
       └─ [完成]→ 循环
       
  └─ 空闲状态 (优先级1)
       │
       └─ 等待 → 循环
```

**配置示例**：
```yaml
Unit: 地精
Workflows:
  - 修复工作流 (优先级7)
  - 建造工作流 (优先级6)
  - 装填工作流 (优先级5)
  - 空闲状态 (优先级1)
  - 逃跑工作流 (优先级10)
```

---

### 地精酒保

```
[地精酒保]
  └─ 逃跑工作流 (优先级10) ━━━━━━━━━━━━━━► [战斗单位]
  └─ 酒保服务工作流 (优先级4)
       │
       ├─ 找酒馆 →[找到]→ 检查食物
       │                  ↓
       │           [缺少]→ 找肉库 → 拿食物 → 送到酒馆 → 存食物
       │           [足够]→ 检查金币
       │                  ↓
       │           [已满]→ 找金库 → 拿金币 → 送到酒馆 → 转金币
       │           [未满]→ 等待
       │
       └─ [完成]→ 循环
```

**配置示例**：
```yaml
Unit: 地精酒保
Workflows:
  - 酒保服务工作流 (优先级4)
  - 空闲状态 (优先级1)
  - 逃跑工作流 (优先级10)
```

---

### 地精铁匠

```
[地精铁匠]
  └─ 逃跑工作流 (优先级10) ━━━━━━━━━━━━━━► [战斗单位]
  └─ 铁匠工作流 (优先级4)
       │
       ├─ 找锻造场 →[找到]→ 检查矿物
       │                     ↓
       │              [足够]→ 移动 →[到达]→ 打造 →[满载]→ 找武器库
       │              [不足]→ 找矿坑 → 拿矿物 → 返回
       │                                                      ↓
       │                                                   存装备
       │
       └─ [完成]→ 循环
```

**配置示例**：
```yaml
Unit: 地精铁匠
Workflows:
  - 铁匠工作流 (优先级4)
  - 空闲状态 (优先级1)
  - 逃跑工作流 (优先级10)
```

---

## 战斗类单位工作流

### 哥布林斥候

```
[哥布林斥候]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 跟随巡逻工作流 (优先级3)
       │
       ├─ 找哨塔 →[找到]→ 找兽人斥候
       │                  ↓
       │           [找到]→ 跟随 →[距离远]→ 移动
       │           [未找到]→ 巡逻
       │                      ↓
       │                   发现敌人 → 战斗工作流
       │
       └─ [完成]→ 循环
```

**配置示例**：
```yaml
Unit: 哥布林斥候
Workflows:
  - 跟随巡逻工作流 (优先级3)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 哥布林战士

```
[哥布林战士]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 守护工作流 (优先级7)
       │
       ├─ 找警戒塔 →[找到]→ 移动 →[到达]→ 守卫
       │                                      ↓
       │                                  发现威胁 → 战斗工作流
       │                                      ↓
       │                                  70%时间守卫
       │                                  30%时间游荡
       │
       └─ [完成]→ 循环
       
  └─ 空闲状态 (优先级1)
       └─ 游荡
```

⚠️ **需补充配置**：时间比例（70%守卫，30%游荡）

**配置示例**：
```yaml
Unit: 哥布林战士
Workflows:
  - 守护工作流 (优先级7)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人

```
[兽人]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 空闲状态 (优先级1)
       │
       └─ 游荡 →[发现敌人]→ 战斗工作流
```

**配置示例**：
```yaml
Unit: 兽人
Workflows:
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人打手

```
[兽人打手]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 守护工作流 (优先级7)
       │
       ├─ 找当前酒馆 →[找到]→ 移动 →[到达]→ 守卫
       │                                      ↓
       │                                  发现威胁 → 战斗工作流
       │
       └─ [完成]→ 循环
```

⚠️ **需补充配置**："当前酒馆"建筑关联

**配置示例**：
```yaml
Unit: 兽人打手
Workflows:
  - 守护工作流 (优先级7)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人斥候

```
[兽人斥候]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 巡逻工作流 (优先级3)
       │
       ├─ 找哨塔 →[找到]→ 移动 →[到达]→ 巡逻
       │                                    ↓
       │                                发现敌人 → 战斗工作流
       │                                    ↓
       │                              基地范围内巡逻
       │
       └─ [完成]→ 循环
```

⚠️ **需补充配置**："当前基地范围"配置

**配置示例**：
```yaml
Unit: 兽人斥候
Workflows:
  - 巡逻工作流 (优先级3)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人猎手

```
[兽人猎手]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 狩猎工作流 (优先级5)
       │
       ├─ 找狩猎场 →[找到]→ 移动 →[到达]→ 狩猎 →[满载]→ 找狩猎塔
       │                                                      ↓
       │                                                   分解猎物
       │                                                      ↓
       │                                                   找肉库
       │                                                      ↓
       │                                                   存食物
       │
       └─ [完成]→ 循环
```

**配置示例**：
```yaml
Unit: 兽人猎手
Workflows:
  - 狩猎工作流 (优先级5)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人劲弩猎手

```
[兽人劲弩猎手]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 狩猎工作流 (优先级5)
       │
       └─ (与兽人猎手相同)
```

**配置示例**：
```yaml
Unit: 兽人劲弩猎手
Workflows:
  - 狩猎工作流 (优先级5)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人战士

```
[兽人战士]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 守护工作流 (优先级7)
       │
       ├─ 找警戒塔 →[找到]→ 移动 →[到达]→ 守卫
       │                                      ↓
       │                                  发现威胁 → 战斗工作流
       │                                      ↓
       │                                  70%时间守卫
       │                                  30%时间游荡
       │
       └─ [完成]→ 循环
       
  └─ 空闲状态 (优先级1)
       └─ 游荡
```

⚠️ **需补充配置**：时间比例（70%守卫，30%游荡）

**配置示例**：
```yaml
Unit: 兽人战士
Workflows:
  - 守护工作流 (优先级7)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人重装战士

```
[兽人重装战士]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 守护工作流 (优先级7)
       │
       └─ (与兽人战士相同，70%守卫，30%游荡)
       
  └─ 空闲状态 (优先级1)
       └─ 游荡
```

⚠️ **需补充配置**：时间比例（70%守卫，30%游荡）

**配置示例**：
```yaml
Unit: 兽人重装战士
Workflows:
  - 守护工作流 (优先级7)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人角斗士/王牌斗士/冠军

```
[兽人角斗士/王牌斗士/冠军]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 竞技场战斗工作流 (优先级10)
       │
       ├─ 找竞技场 →[找到]→ 移动 →[到达]→ 找对手
       │                                    ↓
       │                             [找到]→ 移动 →[到达]→ 攻击
       │                                                      ↓
       │                                            [冷却]→ 等待 → 攻击
       │                                                      ↓
       │                                            [一方血量≤30%]→ 停止
       │                                                      ↓
       │                                            [胜利]→ 检查晋级
       │                                                      ↓
       │                                            [次数够]→ 晋级
       │                                                      ↓
       │                                            [完成]→ 游荡
       │
       ├─ 20%时间竞技场
       │  80%时间游荡
       │
       └─ [完成]→ 循环
       
  └─ 空闲状态 (优先级1)
       └─ 游荡
```

⚠️ **需补充配置**：时间比例（20%竞技场，80%游荡）

✅ **已配置**：30%生命值停止机制、晋级系统

**配置示例**：
```yaml
Unit: 兽人角斗士/王牌斗士/冠军
Workflows:
  - 竞技场战斗工作流 (优先级10)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人驯兽师

```
[兽人驯兽师]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 驯服工作流 (优先级4)
       │
       ├─ 找野兽 →[找到]→ 移动 →[到达]→ 捕获 →[满载]→ 找驯兽塔
       │                                                      ↓
       │                                                   存野兽
       │                                                      ↓
       │                                                   驯服
       │                                                      ↓
       │                                                   完成
       │
       └─ [完成]→ 循环
```

⚠️ **需补充配置**：跟随兽人猎手逻辑

**配置示例**：
```yaml
Unit: 兽人驯兽师
Workflows:
  - 驯服工作流 (优先级4)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 兽人萨满

```
[兽人萨满]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 治疗工作流 (优先级5)
       │
       ├─ 找友方受伤单位 →[找到]→ 检查魔力
       │                          ↓
       │                   [足够]→ 移动 →[到达]→ 治疗
       │                   [不足]→ 找献祭塔
       │
       └─ [完成]→ 循环
       
  └─ 仪式工作流 (优先级3)
       │
       ├─ 找献祭塔 →[找到]→ 检查魔力 →[足够]→ 移动 →[到达]→ 仪式
       │                                                      ↓
       │                                             [完成]→ 随机召唤
       │                                                      ↓
       │                                             30%时间仪式
       │                                             70%时间游荡
       │
       └─ [完成]→ 循环
       
  └─ 空闲状态 (优先级1)
       └─ 游荡
```

⚠️ **需补充配置**：时间比例（30%仪式，70%游荡）

**配置示例**：
```yaml
Unit: 兽人萨满
Workflows:
  - 治疗工作流 (优先级5)
  - 仪式工作流 (优先级3)
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

### 狼人/巨魔/牛头人/半人马

```
[狼人/巨魔/牛头人/半人马]
  └─ 战斗工作流 (优先级10) ━━━━━━━━━━━━━━► [敌人]
  └─ 空闲状态 (优先级1)
       │
       └─ 游荡 →[发现敌人]→ 战斗工作流
```

✅ **已配置**：召唤系统

**配置示例**：
```yaml
Unit: 狼人/巨魔/牛头人/半人马
Workflows:
  - 空闲状态 (优先级1)
  - 战斗工作流 (优先级10)
```

---

## 工作流优先级体系

| 优先级 | 名称           | 适用场景            | 示例                   |
| ------ | -------------- | ------------------- | ---------------------- |
| 10     | Combat         | 战斗中/敌人发现     | 战斗、逃跑、竞技场     |
| 7      | Guard/Repair   | 守护建筑/修复建筑   | 守护、修复             |
| 6      | Build          | 建造建筑            | 建造                   |
| 5      | Mining/Hunting | 挖矿/狩猎/装填/治疗 | 挖矿、狩猎、装填、治疗 |
| 4      | Service/Taming | 服务/驯服/打造      | 酒保、驯服、铁匠       |
| 3      | Patrol/Ritual  | 巡逻/仪式           | 巡逻、仪式             |
| 1      | Idle           | 空闲                | 游荡                   |

---

## 状态指示器实现规范

### 视觉设计

**指示器样式**：
- **位置**：单位渲染右上角
  - 相对于单位中心点（0, 0）的偏移量：`Vector2(12, -14)`
  - 单位大小为 32x32 像素时，指示器应位于右上角区域
- **形状**：空心矩形（仅边框，不填充）
- **尺寸**：宽度 8 像素，高度 12 像素
- **边框宽度**：2 像素
- **颜色**：根据当前状态动态变化（见状态颜色配置表）

**渲染实现**：
```gdscript
# 伪代码示例
func draw_state_indicator():
    var state_name = get_current_state_name()
    var color = get_state_color(state_name)
    var position = unit_position + Vector2(12, -14)  # 右上角偏移
    var size = Vector2(8, 12)
    var border_width = 2
    
    # 绘制空心矩形边框
    draw_rect_outline(position, size, color, border_width)
```

### 状态颜色快速参考表

**核心状态**（20种基础状态）：
- 🟡 **IdleState** - 黄色 - 空闲
- 🔵 **MoveToTargetState** - 蓝色 - 移动中
- 🟢 **InteractionState** - 绿色 - 交互中
- 🔴 **AttackState** - 红色 - 攻击中
- 🟠 **FleeState** - 橙色 - 逃跑中
- 🔷 **FindTargetState** - 青色 - 查找目标
- 🔹 **FindStorageState** - 浅蓝 - 查找存储
- 🔸 **MoveToPositionState** - 深蓝 - 移动到位置
- 🟣 **PatrolState** - 紫红 - 巡逻中
- 🟤 **GuardState** - 棕色 - 守卫中
- ⚪ **WaitState** - 灰色 - 等待中

**扩展状态**（工作流专用）：
- 🟢 **BuildState** - 金绿色 - 建造中
- 🟡 **RepairState** - 金色 - 修复中
- 🟤 **CraftState** - 古铜色 - 打造中
- 🔴 **HuntState** - 深绿 - 狩猎中

---

## 需要补充的配置细节

### 1. 时间比例配置

需要为以下单位配置时间比例：

| 单位         | 需求                  | 配置比例  |
| ------------ | --------------------- | --------- |
| 哥布林战士   | 守护{长} / 游荡{短}   | 70% / 30% |
| 兽人战士     | 守护{长} / 游荡{短}   | 70% / 30% |
| 兽人重装战士 | 守护{长} / 游荡{短}   | 70% / 30% |
| 角斗士系列   | 竞技场{短} / 游荡{长} | 20% / 80% |
| 兽人萨满     | 仪式{短} / 游荡{长}   | 30% / 70% |

### 2. 建筑关联配置

| 单位       | 需求         | 配置项   |
| ---------- | ------------ | -------- |
| 兽人打手   | 守护当前酒馆 | 建筑关联 |
| 兽人斥候   | 当前基地范围 | 范围配置 |
| 兽人驯兽师 | 跟随兽人猎手 | 跟随AI   |

### 3. 特殊机制（已配置 ✅）

- 竞技场30%生命值停止机制
- 角斗士晋级系统
- 萨满召唤系统

---

## 配置系统实现建议

### 统一工作流构建API

```python
class WorkflowBuilder:
    def create_workflow(name, priority):
        """创建新工作流"""
        pass
    
    def add_state(state_name, params, transitions):
        """添加状态机"""
        pass
    
    def set_context(inputs, output):
        """设置上下文数据"""
        pass
    
    def build(self):
        """构建工作流"""
        pass
```

### 统一单位工作流注册API

```python
class UnitWorkflowRegistry:
    def register_unit(unit_type):
        """注册单位类型"""
        pass
    
    def add_workflow(workflow_name, trigger, interrupt):
        """为单位添加工作流"""
        pass
    
    def set_priority_rule(rules):
        """设置优先级规则"""
        pass
    
    def finalize(self):
        """完成注册"""
        pass
```

### 配置加载流程

1. 加载工作流配置文件 → 构建工作流对象
2. 加载单位配置 → 注册工作流
3. 验证配置完整性
4. 运行时动态切换工作流

---

## 工作流配置优势

1. **统一管理**：所有工作流使用统一配置结构
2. **易于扩展**：新增单位=创建工作流+注册工作流
3. **高度复用**：状态机可被多个工作流共享
4. **灵活配置**：通过配置即可组合出新工作流
5. **动态切换**：支持运行时根据条件切换工作流
6. **状态恢复**：被中断的工作流可以完整恢复

---

## 工作流配置总评

### ✅ 完全匹配（12种单位）

- 哥布林、地精、地精酒保、地精铁匠（功能类）
- 哥布林斥候、兽人、兽人猎手、兽人劲弩猎手（战斗类）
- 狼人、巨魔、牛头人、半人马（召唤类）

### ⚠️ 需补充配置（10种单位）

| 单位         | 需补充配置 | 优先级 |
| ------------ | ---------- | ------ |
| 哥布林战士   | 时间比例   | 中     |
| 兽人战士     | 时间比例   | 中     |
| 兽人重装战士 | 时间比例   | 中     |
| 兽人角斗士   | 时间比例   | 低     |
| 兽人王牌斗士 | 时间比例   | 低     |
| 兽人冠军     | 时间比例   | 低     |
| 兽人萨满     | 时间比例   | 中     |
| 兽人打手     | 建筑关联   | 低     |
| 兽人斥候     | 基地范围   | 中     |
| 兽人驯兽师   | 跟随AI     | 高     |

---

## 下一步行动

1. **高优先级**：实现兽人驯兽师的跟随AI
2. **中优先级**：补充时间比例配置系统
3. **低优先级**：建筑关联配置和范围配置

---

*最后更新：2025-01-19（流程图重构，统一API设计）*
