# 地图生成系统

## 概述

MazeMaster2D 的地图生成系统采用程序化生成技术，通过空洞系统、泊松圆盘分布算法和地形管理系统，自动创建游戏地图。系统支持多种空洞类型，并使用智能算法确保资源分布的均匀性和地图的可玩性。

## 核心组件

### 1. 地形管理（TerrainManager）

TerrainManager 使用二维数组 `TerrainType[,]` 管理地图地形数据。

**主要功能**：
- 初始化、设置、获取地形类型
- 批量挖掘操作
- 边界检查和位置验证

**关键方法**：
- `InitializeTerrain(width, height, defaultType)` - 初始化地图地形
- `SetTerrainType(x, y, type)` - 设置地形类型
- `GetTerrainType(x, y)` - 获取地形类型
- `DigTerrain(start, end, targetType)` - 批量挖掘

### 2. 空洞系统（Cavity System）

#### Cavity 数据结构

空洞数据结构包含完整的空洞信息：

- `id` - 唯一标识
- `type` - 空洞类型（Critical, Functional, Ecosystem）
- `center` - 中心位置
- `size` - 大小
- `positions` - 所有位置列表

**空洞类型（CavityType）**：
- `Critical`：关键建筑空洞（地牢之心、传送门、英雄营地等）
- `Functional`：功能区域空洞（支持后续房间、迷宫系统）
- `Ecosystem`：生态区域空洞（支持后续生态系统）

#### CavityManager

单例管理器，负责空洞的注册、查找、更新：

**主要功能**：
- 注册空洞
- 按类型查找空洞
- 更新空洞状态
- 获取所有空洞

**关键方法**：
- `RegisterCavity(cavity)` - 注册空洞
- `GetCavitiesOfType(type)` - 按类型查找空洞
- `UpdateCavity(id, updatedCavity)` - 更新空洞
- `GetAllCavities()` - 获取所有空洞

### 3. 泊松圆盘分布算法（Poisson Disk Sampling）

使用 Bridson's algorithm 生成均匀分布的点，确保资源点之间的最小距离。

**算法特点**：
- 网格加速结构优化性能
- 确保点之间保持最小距离
- 支持自定义采样范围和密度

**关键参数**：
- `minDistance`：最小距离
- `numAttempts`：采样尝试次数
- `bounds`：采样范围

### 4. 地图生成器（MapGenerator）

MapGenerator 负责整体地图生成流程：

**生成步骤**：
1. **基础地形初始化**（全部未挖掘）
2. **关键建筑空洞生成**（地牢之心、传送门、英雄营地）
3. **功能空洞生成**（使用泊松圆盘算法）
4. **生态空洞生成**（使用泊松圆盘算法）
5. **空洞连接通道生成**（使用 Bresenham 线算法）

**关键方法**：
- `GenerateCriticalCavities()` - 生成关键建筑空洞
- `GenerateFunctionalCavities(count, minDistance)` - 生成功能空洞
- `GenerateEcosystemCavities(count, minDistance)` - 生成生态空洞
- `GenerateConnectingChannels(from, to)` - 生成连接通道

### 5. 可视化调试工具（CavityVisualizer）

CavityVisualizer 提供地图生成可视化调试功能。

**可视化功能**：
- **空洞边界显示**：使用线框显示空洞边界
- **空洞类型颜色区分**：
  - Critical = 红色
  - Functional = 蓝色
  - Ecosystem = 绿色
- **通道可视化**：黄色高亮显示连接通道
- **地形类型网格显示**（可选，调试用）

## 地图生成流程

### 1. 初始化阶段

```
1. TerrainManager 初始化地图（默认全部为未挖掘地形）
2. CavityManager 清空所有空洞记录
3. 设置地图尺寸和生成参数
```

### 2. 空洞生成阶段

```
1. 生成关键建筑空洞（固定位置和大小）
   - 地牢之心：地图中心
   - 传送门：随机位置
   - 英雄营地：随机位置

2. 生成功能空洞（泊松圆盘分布）
   - 在非关键区域使用泊松圆盘算法生成
   - 确保功能空洞之间的最小距离
   - 用于后续房间、迷宫系统集成

3. 生成生态空洞（泊松圆盘分布）
   - 在合适位置生成生态区域
   - 支持森林、湖泊、洞穴等生态内容
```

### 3. 通道连接阶段

```
使用 Bresenham 线算法生成空洞之间的连接通道：
1. 计算空洞中心点之间的路径
2. 沿路径挖掘通道
3. 确保通道宽度至少为 2 格（允许双向通行）
```

### 4. 资源生成阶段

```
在功能空洞中生成资源：
1. 使用 GoldMineGenerator 生成金矿
2. 使用泊松圆盘算法确保金矿均匀分布
3. 自动验证位置（地形、建筑冲突、最小距离）
```

## 挖矿与资源系统集成

### 金矿生成系统

GoldMineGenerator 负责在功能空洞中生成金矿：

**生成逻辑**：
1. 在功能空洞中遍历每个空洞
2. 使用泊松圆盘算法在空洞内生成金矿点
3. 验证每个金矿位置
4. 创建金矿对象

**验证逻辑**：
1. 检查地形类型（必须是空地）
2. 检查建筑冲突（不能与其他建筑重叠）
3. 检查最小距离（与其他金矿的距离）

### 资源节点管理

ResourceNodeManager 统一管理所有资源节点：

**主要功能**：
- 注册资源节点（金矿、资源点等）
- 按类型查找资源节点
- 范围查找（查找指定范围内的资源节点）
- 可用性跟踪（跟踪哪些资源节点已被占用）

**关键方法**：
- `RegisterResourceNode(node)` - 注册资源节点
- `GetNodesByType(type)` - 按类型查找
- `GetNodesInRange(position, range)` - 范围查找
- `SetNodeAvailable(nodeId, available)` - 标记为可用/不可用

### 任务分配系统

TaskAssignmentSystem 负责智能分配任务：

**分配算法**：
```
score = (PRIORITY_WEIGHT * priority) - (DISTANCE_PENALTY * distance)
```

**优先级常量**：
- Combat: 10（战斗中/敌人发现）
- Repair: 7（修复建筑）
- Build: 6（建造建筑）
- Mining: 5（挖矿）

**动态更新**：
- 任务列表每 0.5 秒更新一次
- 根据单位位置和优先级重新分配任务
- 支持任务取消和重新分配

*最后更新：2025-01-09*

